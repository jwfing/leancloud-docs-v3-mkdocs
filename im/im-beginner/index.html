



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.5">
    
    
      
        <title>基础入门 - LeanCloud 文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/mdc-web.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/bootstrap.min.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#_1" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="LeanCloud 文档" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                LeanCloud 文档
              </span>
              <span class="md-header-nav__topic">
                基础入门
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." title="文档首页" class="md-tabs__link">
        文档首页
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../storage/storage-overview/" title="数据存储" class="md-tabs__link">
          数据存储
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../engine/engine-overview/" title="云引擎+云缓存" class="md-tabs__link">
          云引擎+云缓存
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../im-overview/" title="即时通讯" class="md-tabs__link md-tabs__link--active">
          即时通讯
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../push/push-overview/" title="消息推送" class="md-tabs__link">
          消息推送
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../sms/sms-overview/" title="短信" class="md-tabs__link">
          短信
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../game/play/play-overview/" title="游戏+云端" class="md-tabs__link">
          游戏+云端
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../solution/weapp/" title="微信小程序" class="md-tabs__link">
          微信小程序
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="LeanCloud 文档" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    LeanCloud 文档
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="文档首页" class="md-nav__link">
      文档首页
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      数据存储
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        数据存储
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage/storage-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage/object.md" title="对象存储与查询" class="md-nav__link">
      对象存储与查询
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage/user.md" title="用户管理" class="md-nav__link">
      用户管理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage/live-query.md" title="实时数据同步 LiveQuery" class="md-nav__link">
      实时数据同步 LiveQuery
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage/acl/" title="数据安全详解" class="md-nav__link">
      数据安全详解
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      云引擎+云缓存
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        云引擎+云缓存
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/engine-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/start.md" title="快速入门" class="md-nav__link">
      快速入门
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      网站托管
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        网站托管
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/nodejs.md" title="NodeJS" class="md-nav__link">
      NodeJS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/python.md" title="Python" class="md-nav__link">
      Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/php.md" title="PHP" class="md-nav__link">
      PHP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/dotnet.md" title="C#" class="md-nav__link">
      C#
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      云函数
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        云函数
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/storage-hook.md" title="数据存储 Hook" class="md-nav__link">
      数据存储 Hook
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/im-hook.md" title="即时通讯 Hook" class="md-nav__link">
      即时通讯 Hook
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/leancache.md" title="云缓存 LeanCache 使用指南" class="md-nav__link">
      云缓存 LeanCache 使用指南
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/faq.md" title="云引擎常见问题" class="md-nav__link">
      云引擎常见问题
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lean-cli.md" title="命令行工具 CLI 使用指南" class="md-nav__link">
      命令行工具 CLI 使用指南
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      即时通讯
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        即时通讯
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../im-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2" checked>
    
    <label class="md-nav__link" for="nav-4-2">
      客户端开发指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        客户端开发指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        基础入门
      </label>
    
    <a href="./" title="基础入门" class="md-nav__link md-nav__link--active">
      基础入门
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" title="使用场景和解决的需求" class="md-nav__link">
    使用场景和解决的需求
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="阅前准备" class="md-nav__link">
    阅前准备
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" title="一对一单聊" class="md-nav__link">
    一对一单聊
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-imclient" title="1.创建 IMClient" class="md-nav__link">
    1.创建 IMClient
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" title="2.建立连接" class="md-nav__link">
    2.建立连接
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-conversation" title="3.创建对话 Conversation" class="md-nav__link">
    3.创建对话 Conversation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" title="4.发送消息" class="md-nav__link">
    4.发送消息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" title="5.接收消息" class="md-nav__link">
    5.接收消息
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" title="多人群聊" class="md-nav__link">
    多人群聊
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" title="1.创建多人群聊对话" class="md-nav__link">
    1.创建多人群聊对话
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" title="2.群发消息" class="md-nav__link">
    2.群发消息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="将他人踢出对话" class="md-nav__link">
    将他人踢出对话
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="加入对话" class="md-nav__link">
    加入对话
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="退出对话" class="md-nav__link">
    退出对话
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="成员变更的事件通知总结" class="md-nav__link">
    成员变更的事件通知总结
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" title="其他对话类型（聊天模式）" class="md-nav__link">
    其他对话类型（聊天模式）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" title="对话" class="md-nav__link">
    对话
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" title="获取对话列表" class="md-nav__link">
    获取对话列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="根据关键字查询" class="md-nav__link">
    根据关键字查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="更多查询方式" class="md-nav__link">
    更多查询方式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" title="消息" class="md-nav__link">
    消息
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" title="图像消息" class="md-nav__link">
    图像消息
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" title="发送图像文件" class="md-nav__link">
    发送图像文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" title="发送图像链接" class="md-nav__link">
    发送图像链接
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" title="接收图像消息" class="md-nav__link">
    接收图像消息
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" title="多媒体消息" class="md-nav__link">
    多媒体消息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" title="其他类型消息" class="md-nav__link">
    其他类型消息
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_22" title="消息记录" class="md-nav__link">
    消息记录
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" title="获取对话的全部消息记录" class="md-nav__link">
    获取对话的全部消息记录
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" title="按照消息类型获取" class="md-nav__link">
    按照消息类型获取
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" title="更多的获取方式" class="md-nav__link">
    更多的获取方式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" title="客户端事件与网络状态响应" class="md-nav__link">
    客户端事件与网络状态响应
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" title="断线重连" class="md-nav__link">
    断线重连
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_28" title="退出登录与断开连接" class="md-nav__link">
    退出登录与断开连接
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../im-intermediate.md" title="进阶功能" class="md-nav__link">
      进阶功能
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../im-senior.md" title="高阶技巧" class="md-nav__link">
      高阶技巧
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3">
    
    <label class="md-nav__link" for="nav-4-3">
      服务端开发指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-3">
        服务端开发指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3-1" type="checkbox" id="nav-4-3-1">
    
    <label class="md-nav__link" for="nav-4-3-1">
      Hook
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-3-1">
        Hook
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/hook-nodejs.md" title="NodeJS" class="md-nav__link">
      NodeJS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/hook-python.md" title="Python" class="md-nav__link">
      Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/hook-php.md" title="PHP" class="md-nav__link">
      PHP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/hook-dotnet.md" title="C#" class="md-nav__link">
      C#
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3-2" type="checkbox" id="nav-4-3-2">
    
    <label class="md-nav__link" for="nav-4-3-2">
      管理开发指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-3-2">
        管理开发指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/server-python.md" title="Python" class="md-nav__link">
      Python
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      消息推送
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        消息推送
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../push/push-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      开发指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        开发指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2-1" type="checkbox" id="nav-5-2-1">
    
    <label class="md-nav__link" for="nav-5-2-1">
      iOS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-2-1">
        iOS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../push/apns-cert/" title="APNS 证书配置" class="md-nav__link">
      APNS 证书配置
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2-2" type="checkbox" id="nav-5-2-2">
    
    <label class="md-nav__link" for="nav-5-2-2">
      Android
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-2-2">
        Android
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../push/android-mixpush/" title="Android 混合推送" class="md-nav__link">
      Android 混合推送
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      短信
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        短信
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../sms/sms-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2">
    
    <label class="md-nav__link" for="nav-6-2">
      开发指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        开发指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../sms/marketing/" title="营销短信" class="md-nav__link">
      营销短信
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../sms/notice/" title="通知短信" class="md-nav__link">
      通知短信
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../sms/user/" title="用户验证类短信" class="md-nav__link">
      用户验证类短信
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      游戏+云端
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        游戏+云端
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-1" type="checkbox" id="nav-7-1">
    
    <label class="md-nav__link" for="nav-7-1">
      多人实时对战
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-1">
        多人实时对战
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../game/play/play-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../game/play/multiplayer/" title="开发指南" class="md-nav__link">
      开发指南
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">
    
    <label class="md-nav__link" for="nav-7-2">
      排行榜
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        排行榜
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../game/leaderboard/leaderboard-overview.md" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../game/leaderboard/leaderboard.md" title="开发指南" class="md-nav__link">
      开发指南
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      微信小程序
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        微信小程序
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../solution/weapp/" title="在微信小程序与小游戏中使用 LeanCloud" class="md-nav__link">
      在微信小程序与小游戏中使用 LeanCloud
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" title="使用场景和解决的需求" class="md-nav__link">
    使用场景和解决的需求
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="阅前准备" class="md-nav__link">
    阅前准备
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" title="一对一单聊" class="md-nav__link">
    一对一单聊
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-imclient" title="1.创建 IMClient" class="md-nav__link">
    1.创建 IMClient
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" title="2.建立连接" class="md-nav__link">
    2.建立连接
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-conversation" title="3.创建对话 Conversation" class="md-nav__link">
    3.创建对话 Conversation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" title="4.发送消息" class="md-nav__link">
    4.发送消息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" title="5.接收消息" class="md-nav__link">
    5.接收消息
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" title="多人群聊" class="md-nav__link">
    多人群聊
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" title="1.创建多人群聊对话" class="md-nav__link">
    1.创建多人群聊对话
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" title="2.群发消息" class="md-nav__link">
    2.群发消息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="将他人踢出对话" class="md-nav__link">
    将他人踢出对话
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="加入对话" class="md-nav__link">
    加入对话
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="退出对话" class="md-nav__link">
    退出对话
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="成员变更的事件通知总结" class="md-nav__link">
    成员变更的事件通知总结
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" title="其他对话类型（聊天模式）" class="md-nav__link">
    其他对话类型（聊天模式）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" title="对话" class="md-nav__link">
    对话
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" title="获取对话列表" class="md-nav__link">
    获取对话列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="根据关键字查询" class="md-nav__link">
    根据关键字查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="更多查询方式" class="md-nav__link">
    更多查询方式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" title="消息" class="md-nav__link">
    消息
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" title="图像消息" class="md-nav__link">
    图像消息
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" title="发送图像文件" class="md-nav__link">
    发送图像文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" title="发送图像链接" class="md-nav__link">
    发送图像链接
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" title="接收图像消息" class="md-nav__link">
    接收图像消息
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" title="多媒体消息" class="md-nav__link">
    多媒体消息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" title="其他类型消息" class="md-nav__link">
    其他类型消息
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_22" title="消息记录" class="md-nav__link">
    消息记录
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" title="获取对话的全部消息记录" class="md-nav__link">
    获取对话的全部消息记录
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" title="按照消息类型获取" class="md-nav__link">
    按照消息类型获取
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" title="更多的获取方式" class="md-nav__link">
    更多的获取方式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" title="客户端事件与网络状态响应" class="md-nav__link">
    客户端事件与网络状态响应
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" title="断线重连" class="md-nav__link">
    断线重连
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_28" title="退出登录与断开连接" class="md-nav__link">
    退出登录与断开连接
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="_1">即时通讯开发指南 &middot; 基础入门<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="_2">使用场景和解决的需求<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>针对如下应用场景，即时通讯都有对应的解决方案：</p>
<ul>
<li>社交应用需要接入聊天功能</li>
<li>游戏需要接入聊天频道</li>
<li>直播应用要接入聊天室弹幕服务</li>
<li>系统广播消息在线通知，游戏 GM 在线全服广播</li>
</ul>
<p>而上述只是一些比较经典和流行的场景，即时通讯不局限于上述用法和场景，我们提供了许多易用性较高的接口支持开发者可以拓展更多的场景和模式。</p>
<p>即时通讯要解决的核心需求就是:</p>
<blockquote>
<p>让你的应用拥有私聊、群聊、聊天室、系统消息等通讯能力</p>
</blockquote>
<p>即时通讯使得开发者可以在不编写服务端的代码的情况下，仅使用客户端 SDK 即可实现在线聊天/多人群组/私聊/消息群发等实时通讯的功能，如下时序图简单的介绍了一下即时通讯的业务流程：</p>
<div class="codehilite"><pre><span></span><span class="nt">ClientA-</span><span class="o">&gt;</span><span class="nt">Cloud</span><span class="o">:</span> <span class="nt">send</span><span class="o">(</span><span class="s1">&#39;大家好，我是 A&#39;</span><span class="o">);</span>
<span class="nt">Cloud--</span><span class="o">&gt;</span><span class="nt">ClientB</span><span class="o">:</span> <span class="nt">onMessage</span><span class="o">(</span><span class="nt">ClientA</span><span class="o">,</span><span class="s1">&#39;大家好，我是 A&#39;</span><span class="o">);</span>
<span class="nt">Cloud--</span><span class="o">&gt;</span><span class="nt">ClientC</span><span class="o">:</span> <span class="nt">onMessage</span><span class="o">(</span><span class="nt">ClientA</span><span class="o">,</span><span class="s1">&#39;大家好，我是 A&#39;</span><span class="o">);</span>
</pre></div>

<h2 id="_3">阅前准备<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>建议先阅读<a href="realtime_v2.html">即时通讯服务总览</a>之后，再阅读本文效果最佳。</p>
<h2 id="_4">一对一单聊<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>我们从最基本的一对一私聊开始接入即时通讯模块，首先我们需要明确一个需求：</p>
<blockquote>
<p>假设我们正在制作一个社交聊天的应用，第一步要实现一个用户向另一个用户发起聊天的功能</p>
</blockquote>
<p>首先我们需要介绍一下在即时通讯服务中的 <code class="codehilite">IMClient</code> 对象：</p>
<blockquote>
<p><code class="codehilite">IMClient</code> 对应实体的是一个用户，它代表着一个用户以客户端的身份登录到了即时通讯的系统。</p>
</blockquote>
<h3 id="1-imclient">1.创建 <code class="codehilite">IMClient</code><a class="headerlink" href="#1-imclient" title="Permanent link">&para;</a></h3>
<p>在 iOS 和 Android SDK 中使用如下代码创建出一个 <code class="codehilite">IMClient</code>:</p>
<p><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">realtime</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Realtime</span><span class="p">({</span>
  <span class="nx">appId</span><span class="o">:</span> <span class="s1">&#39;your-app-id&#39;</span><span class="p">,</span>
  <span class="nx">appKey</span><span class="o">:</span> <span class="s1">&#39;your-app-key&#39;</span><span class="p">,</span>
  <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span><span class="nx">TypedMessagesPlugin</span><span class="p">],</span> <span class="c1">// 注册富媒体消息插件</span>
<span class="p">});</span>
<span class="c1">// Tom 用自己的名字作为 clientId</span>
<span class="nx">realtime</span><span class="p">.</span><span class="nx">createIMClient</span><span class="p">(</span><span class="s1">&#39;Tom&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tom</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 成功登录</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">AVIMClient</span> <span class="o">*</span><span class="n">tom</span><span class="p">;</span>
<span class="c1">// clientId 为 Tom</span>
<span class="n">tom</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AVIMClient</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithClientId</span><span class="p">:</span><span class="s">@&quot;Tom&quot;</span><span class="p">]</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">// clientId 为 Tom</span>
<span class="n">AVIMClient</span> <span class="n">tom</span> <span class="o">=</span> <span class="n">AVIMClient</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;Tom&quot;</span><span class="o">);</span>
</pre></div>
<div class="codehilite"><pre><span></span>var realtime = new AVRealtime(&#39;your-app-id&#39;,&#39;your-app-key&#39;);
var tom = await realtime.CreateClientAsync(&#39;Tom&#39;);
</pre></div></p>
<p>示例代码中 <code class="codehilite">clientId</code> 被设置为 Tom, 这里我们需要明确一下 <code class="codehilite">clientId</code> 的约束：</p>
<ol>
<li>它必须为一个字符串</li>
<li>在一个应用内全局唯一</li>
<li>长度不能超过 64 个字符</li>
</ol>
<p>注： JavaScript 和 C#(Unity3D) SDK 创建 <code class="codehilite">IMClient</code> 成功同时意味着连接也已经建立，而 iOS 和 Android SDK 则需要额外下一步<a href="#2.建立连接">2.建立连接</a></p>
<h3 id="2">2.建立连接<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>建立连接的含义是：</p>
<blockquote>
<p><code class="codehilite">IMClient</code> 建立一个于云端的长连接，然后就可以开始收发消息了，并且可以监听事件。</p>
</blockquote>
<p>对应的 SDK 方法如下：</p>
<p><div class="codehilite"><pre><span></span><span class="c1">// Tom 用自己的名字作为 clientId, 建立长连接，并且获取 IMClient 对象实例</span>
<span class="nx">realtime</span><span class="p">.</span><span class="nx">createIMClient</span><span class="p">(</span><span class="s1">&#39;Tom&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tom</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 成功登录</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">// Tom 创建了一个 client，用自己的名字作为 clientId</span>
<span class="n">AVIMClient</span> <span class="o">*</span><span class="n">tom</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AVIMClient</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithClientId</span><span class="p">:</span><span class="s">@&quot;Tom&quot;</span><span class="p">];</span>
<span class="c1">// Tom 创建连接</span>
<span class="p">[</span><span class="n">tom</span> <span class="nl">openWithCallback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 成功打开连接</span>
  <span class="p">}</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">// Tom 创建了一个 client，用自己的名字作为 clientId</span>
<span class="n">AVIMClient</span> <span class="n">tom</span> <span class="o">=</span> <span class="n">AVIMClient</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;Tom&quot;</span><span class="o">);</span>
<span class="c1">// Tom 创建连接</span>
<span class="n">tom</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="k">new</span> <span class="n">AVIMClientCallback</span><span class="o">()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMClient</span> <span class="n">client</span><span class="o">,</span> <span class="n">AVIMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 成功打开连接</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span></span>var realtime = new AVRealtime(&#39;your-app-id&#39;,&#39;your-app-key&#39;);
var tom = await realtime.CreateClientAsync(&#39;Tom&#39;);
</pre></div></p>
<p>注：JavaScript 和 C#(Unity3D) SDK 建立连接成功之后，会返回一个 <code class="codehilite">IMClient</code>。</p>
<p>推荐使用的方式：在用户登录之后用当前的用户名当做 <code class="codehilite">clientId</code> 来创建 <code class="codehilite">IMClient</code> 并建立连接。</p>
<p>我们推荐在连接创建成功之后订阅<a href="#客户端事件与网络状态响应">客户端事件与网络状态响应</a>，针对网络的异常情况作出应有的 UI 展示，以确保应用的健壮性。</p>
<h3 id="3-conversation">3.创建对话 <code class="codehilite">Conversation</code><a class="headerlink" href="#3-conversation" title="Permanent link">&para;</a></h3>
<p>对话(<code class="codehilite">Conversation</code>) 是即时通讯抽象出来的概念，它是客户端之间互发消息的载体，可以理解为一个通道，所有在这个对话内的成员都可以在这个对话内收发消息:</p>
<blockquote>
<p>对话(<code class="codehilite">Conversation</code>)对话是消息的载体，所有消息的目标都是对话，而所有在对话中的成员都会接收到对话内产生的消息。</p>
</blockquote>
<p>Tom 已经建立了连接，因此他需要创建一个 <code class="codehilite">Conversation</code> 来发送消息给 Jerry：</p>
<p><div class="codehilite"><pre><span></span><span class="c1">// 创建与 Jerry 之间的对话</span>
<span class="k">return</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">createConversation</span><span class="p">({</span>
  <span class="c1">// 指定对话的成员除了当前用户 Tom(SDK 会默认把当前用户当做对话成员)之外，还有 Jerry</span>
  <span class="nx">members</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;Jerry&#39;</span><span class="p">],</span>
  <span class="c1">// 对话名称</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Tom &amp; Jerry&#39;</span><span class="p">,</span>
<span class="p">});.</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">// 创建与 Jerry 之间的对话</span>
<span class="p">[</span><span class="n">tom</span> <span class="nl">createConversationWithName</span><span class="p">:</span><span class="s">@&quot;Tom &amp; Jerry&quot;</span> <span class="nl">clientIds</span><span class="p">:</span><span class="l">@[</span><span class="s">@&quot;Jerry&quot;</span><span class="l">]</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">AVIMConversation</span> <span class="o">*</span><span class="n">conversation</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">tom</span><span class="o">.</span><span class="na">createConversation</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;Jerry&quot;</span><span class="o">),</span> <span class="s">&quot;Tom &amp; Jerry&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> 
    <span class="k">new</span> <span class="n">AVIMConversationCreatedCallback</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMConversation</span> <span class="n">conversation</span><span class="o">,</span> <span class="n">AVIMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span><span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 创建成功</span>
          <span class="o">}</span>
        <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="nt">var</span> <span class="nt">tom</span> <span class="o">=</span> <span class="nt">await</span> <span class="nt">realtime</span><span class="p">.</span><span class="nc">CreateClientAsync</span><span class="o">(</span><span class="s1">&#39;Tom&#39;</span><span class="o">);</span>
<span class="nt">var</span> <span class="nt">conversation</span> <span class="o">=</span> <span class="nt">await</span> <span class="nt">tom</span><span class="p">.</span><span class="nc">CreateConversationAsync</span><span class="o">(</span><span class="s2">&quot;Jerry&quot;</span><span class="o">,</span><span class="nt">name</span><span class="o">:</span><span class="s2">&quot;Tom &amp; Jerry&quot;</span><span class="o">);</span>
</pre></div>

<code class="codehilite">createConversation</code> 这个接口会直接创建一个对话，并且该对话会被存储在 <code class="codehilite">_Conversation</code> 表内，可以打开控制台-&gt;存储查看数据。</p>
<p><code class="codehilite">createConversation</code> 的参数详解:</p>
<p>{{ docs.langSpecStart('js') }}</p>
<ol>
<li><code class="codehilite">members</code> : 字符串数组，必要参数，对话的初始成员(clientId)列表，默认包含当前 clientId</li>
<li><code class="codehilite">name</code>: 字符串，可选参数，对话的名字，如果不传默认值为 null</li>
<li><code class="codehilite">unique</code>： bool 类型，可选参数，是否唯一对话，当其为 true 时，如果当前已经有相同成员的对话存在则返回该对话，否则会创建新的对话</li>
</ol>
<p>{{ docs.langSpecEnd('js') }}</p>
<p>{{ docs.langSpecStart('objc') }}</p>
<ol>
<li>name － 表示对话名字，可以指定任意有意义的名字，也可不填。</li>
<li>clientIds － 表示对话初始成员，可不填。如果填写了初始成员，则 LeanCloud 云端会直接给这些成员发出邀请，省掉再专门发一次邀请请求。</li>
<li>attributes － 表示额外属性，Dictionary，支持任意的 key/value，可不填。</li>
<li>options － 对话选项：</li>
<li>AVIMConversationOptionTransient：聊天室，具体可以参见创建聊天室；</li>
<li>AVIMConversationOptionNone：普通对话；</li>
<li>AVIMConversationOptionTemporary：临时对话；</li>
<li>AVIMConversationOptionUnique：根据成员（clientIds）创建原子对话。如果没有这个选项，服务端会为相同的 clientIds 创建新的对话。clientIds 即 _Conversation 表的 m 字段。</li>
<li>callback － 结果回调，在操作结束之后调用，通知开发者成功与否。</li>
</ol>
<p>{{ docs.langSpecEnd('objc') }}</p>
<p>{{ docs.langSpecStart('java') }}</p>
<ol>
<li>members - 对话的成员</li>
<li>name - 对话的名字</li>
<li>attributes - 对话的额外属性</li>
<li>isTransient - 是否是暂态会话</li>
<li>isUnique - 如果已经存在符合条件的会话，是否返回已有回话 为 false 时，则一直为创建新的回话 为 true 时，则先查询，如果已有符合条件的回话，则返回已有的，否则，创建新的并返回 为 true      时，仅 members 为有效查询条件</li>
<li>callback - 结果回调函数</li>
</ol>
<p>{{ docs.langSpecEnd('java') }}</p>
<p>{{ docs.langSpecStart('cs') }}</p>
<ol>
<li><code class="codehilite">members</code> : 字符串数组，必要参数，对话的初始成员(clientId)列表，默认包含当前 clientId</li>
<li><code class="codehilite">name</code>: 字符串，可选参数，对话的名字，如果不传默认值为 null</li>
<li><code class="codehilite">isSystem</code>: bool 值，可选参数，是否是服务号</li>
<li><code class="codehilite">isTransient</code>:bool 值，可选参数，是否为聊天室</li>
<li><code class="codehilite">isUnique</code>： bool 类型，可选参数，是否唯一对话，当其为 true 时，如果当前已经有相同成员的对话存在则返回该对话，否则会创建新的对话</li>
<li><code class="codehilite">options</code>：字典类型，可选参数，额外的自定义属性</li>
</ol>
<p>{{ docs.langSpecEnd('cs') }}</p>
<p>创建对话之后，可以获取对话的内置属性，云端会为每一个对话生成一个全局唯一的 ID 属性： <code class="codehilite">Conversation.id</code>，它是查询对话和获取对话时常用的匹配字段。</p>
<h3 id="4">4.发送消息<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<p>对话已经创建成功了，接下来 Tom 可以发出第一条文本消息了：

<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="p">{</span> <span class="nx">TextMessage</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-realtime&#39;</span><span class="p">);</span>
<span class="nx">conversation</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="k">new</span> <span class="nx">TextMessage</span><span class="p">(</span><span class="s1">&#39;Jerry，起床了！&#39;</span><span class="p">)).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Tom &amp; Jerry&#39;</span><span class="p">,</span> <span class="s1">&#39;发送成功！&#39;</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="p">[</span><span class="n">conversation</span> <span class="nl">sendMessage</span><span class="p">:[</span><span class="n">AVIMTextMessage</span> <span class="nl">messageWithText</span><span class="p">:</span><span class="s">@&quot;耗子，起床！&quot;</span> <span class="nl">attributes</span><span class="p">:</span><span class="nb">nil</span><span class="p">]</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;发送成功！&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">AVIMTextMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AVIMTextMessage</span><span class="o">();</span>
<span class="n">msg</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;Jerry，起床了！&quot;</span><span class="o">);</span>
<span class="c1">// 发送消息</span>
<span class="n">conversation</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="k">new</span> <span class="n">AVIMConversationCallback</span><span class="o">()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;Tom &amp; Jerry&quot;</span><span class="o">,</span> <span class="s">&quot;发送成功！&quot;</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>var textMessage = new AVIMTextMessage(&quot;Jerry，起床了！&quot;);
await conversation.SendAsync(textMessage);
</pre></div></p>
<p><code class="codehilite">conversation.send</code> 接口实现的功能就是向对话中发送一条消息。</p>
<p>Jerry 只要在线他就会收到消息，至此 Jerry 还没有登场，那么他怎么接收消息呢？
</p>
<h3 id="5">5.接收消息<a class="headerlink" href="#5" title="Permanent link">&para;</a></h3>
<p>我们在另一个设备上启动应用，然后使用 Jerry 当做 <code class="codehilite">clientId</code> 创建 <code class="codehilite">AVIMClient</code> 和 建立连接（参照前两章节 Tom 的示例代码）:</p>
<p><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="p">{</span> <span class="nx">Event</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-realtime&#39;</span><span class="p">);</span>
<span class="c1">// Jerry 登录</span>
<span class="nx">realtime</span><span class="p">.</span><span class="nx">createIMClient</span><span class="p">(</span><span class="s1">&#39;Jerry&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">jerry</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">jerry</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AVIMClient</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithClientId</span><span class="p">:</span><span class="s">@&quot;Jerry&quot;</span><span class="p">];</span>
<span class="p">[</span><span class="n">jerry</span> <span class="nl">openWithCallback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">//Jerry登录</span>
<span class="n">AVIMClient</span> <span class="n">jerry</span> <span class="o">=</span> <span class="n">AVIMClient</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;Jerry&quot;</span><span class="o">);</span>
<span class="n">jerry</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="k">new</span> <span class="n">AVIMClientCallback</span><span class="o">(){</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMClient</span> <span class="n">client</span><span class="o">,</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">){</span>
      <span class="k">if</span><span class="o">(</span><span class="n">e</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
        <span class="o">...</span><span class="c1">//登录成功后的逻辑</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>var realtime = new AVRealtime(&#39;your-app-id&#39;,&#39;your-app-key&#39;);
var jerry = await realtime.CreateClientAsync(&#39;Jerry&#39;);
</pre></div></p>
<p>紧接着让 Jerry 开始订阅对话加入的事件通知：</p>
<p><div class="codehilite"><pre><span></span><span class="c1">// 当前用户被添加至某个对话</span>
<span class="nx">jerry</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">INVITED</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">invitedEventHandler</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">invitedBy</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">jerry</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">conversation:</span><span class="p">(</span><span class="n">AVIMConversation</span> <span class="o">*</span><span class="p">)</span><span class="nv">conversation</span> <span class="nf">invitedByClientId:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientId</span><span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;当前 ClientId(Jerry) 被 %@ 邀请，加入了对话&quot;</span><span class="p">,</span><span class="n">clientId</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomConversationEventHandler</span> <span class="kd">extends</span> <span class="n">AVIMConversationEventHandler</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onInvited</span><span class="o">(</span><span class="n">AVIMClient</span> <span class="n">client</span><span class="o">,</span> <span class="n">AVIMConversation</span> <span class="n">conversation</span><span class="o">,</span> <span class="n">String</span> <span class="n">invitedBy</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 当前 ClientId(Jerry) 被邀请到对话，执行此处逻辑</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="n">AVIMMessageManager</span><span class="o">.</span><span class="na">registerDefaultMessageHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomMessageHandler</span><span class="o">());</span>
</pre></div>
<div class="codehilite"><pre><span></span>var jerry =await realtime.CreateClientAsync(&quot;Jerry&quot;);
jerry.OnInvited += (sender, args) =&gt;
{
  var invitedBy = args.InvitedBy;
  var conversationId = args.ConversationId;
};
</pre></div></p>
<p>为 Jerry 添加了加入对话的事件订阅之后，继续为 Jerry 订阅消息接收的事件：</p>
<p><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="p">{</span> <span class="nx">Event</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-realtime&#39;</span><span class="p">);</span>
<span class="c1">// Jerry 登录</span>
<span class="nx">realtime</span><span class="p">.</span><span class="nx">createIMClient</span><span class="p">(</span><span class="s1">&#39;Jerry&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">jerry</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 当前用户收到了某一条消息</span>
    <span class="nx">jerry</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">MESSAGE</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Message received: &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">jerry</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
<span class="cp">#pragma mark - AVIMClientDelegate</span>
<span class="c1">// 接收消息的回调函数</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">conversation:</span><span class="p">(</span><span class="n">AVIMConversation</span> <span class="o">*</span><span class="p">)</span><span class="nv">conversation</span> <span class="nf">didReceiveTypedMessage:</span><span class="p">(</span><span class="n">AVIMTypedMessage</span> <span class="o">*</span><span class="p">)</span><span class="nv">message</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">text</span><span class="p">);</span> <span class="c1">// Jerry，起床了！</span>
<span class="p">}</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CustomMessageHandler</span> <span class="kd">extends</span> <span class="n">AVIMMessageHandler</span><span class="o">{</span>
   <span class="c1">//接收到消息后的处理逻辑 </span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">AVIMMessage</span> <span class="n">message</span><span class="o">,</span><span class="n">AVIMConversation</span> <span class="n">conversation</span><span class="o">,</span><span class="n">AVIMClient</span> <span class="n">client</span><span class="o">){</span>
     <span class="k">if</span><span class="o">(</span><span class="n">message</span> <span class="k">instanceof</span> <span class="n">AVIMTextMessage</span><span class="o">){</span>
       <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(((</span><span class="n">AVIMTextMessage</span><span class="o">)</span><span class="n">message</span><span class="o">).</span><span class="na">getText</span><span class="o">());</span><span class="c1">// Jerry，起床了</span>
     <span class="o">}</span>
   <span class="o">}</span>
 <span class="o">}</span>

<span class="n">AVIMMessageManager</span><span class="o">.</span><span class="na">registerDefaultMessageHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomMessageHandler</span><span class="o">());</span>
</pre></div>
<div class="codehilite"><pre><span></span>jerry.OnMessageReceived += Jerry_OnMessageReceived;
private void Jerry_OnMessageReceived(object sender, AVIMMessageEventArgs e)
{
    if (e.Message is AVIMTextMessage)
    {
        var textMessage = (AVIMTextMessage)e.Message;
        // textMessage.ConversationId 是该条消息所属于的对话 Id
        // textMessage.TextContent 是该文本消息的文本内容
        // textMessage.FromClientId 是消息发送者的 client Id
    }
}
</pre></div></p>
<p>而当 Tom 创建了对话之后，Jerry 会这一端会立即触发 <code class="codehilite">INVITED</code>（更多关于 <code class="codehilite">INVITED</code> 的描述在<a href="#成员变更的事件通知总结">成员变更的事件通知总结</a>），此时客户端可以做出一些 UI 展示，引导用户加载聊天的界面，紧接着 Tom 发送了消息，则会触发 Jerry <code class="codehilite">MESSAGE</code>，这个时候就可以直接在聊天界面的消息列表里面渲染这条消息了。</p>
<p>对应的时序图如下:</p>
<div class="codehilite"><pre><span></span>Tom-&gt;Cloud: 1.Tom 将 Jerry 加入对话
Cloud--&gt;Jerry: 2.下发通知：你被邀请加入对话
Jerry--&gt;UI: 3.加载聊天的 UI 界面
Tom-&gt;Cloud: 4.发送消息
Cloud--&gt;Jerry: 5.下发通知：接收到有新消息
Jerry--&gt;UI: 6.显示收到的消息内容
</pre></div>

<h2 id="_5">多人群聊<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>多人群聊与单聊十分接近，在一个现有对话上加入更多的成员即可转化为群聊：</p>
<h3 id="1">1.创建多人群聊对话<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>多人群聊的对话可以通过如下两种方式实现：</p>
<ol>
<li><strong>向现有对话中添加更多成员</strong></li>
<li><strong>重新创建一个对话，并在创建的时候指定至少 2 名成员</strong></li>
</ol>
<p>首先我们实现第一种方式： <strong>向现有对话中添加更多成员</strong>，将其转化成一个群聊。</p>
<p>Tom 继续添加 Mary 到对话中：</p>
<p><div class="codehilite"><pre><span></span><span class="nx">tom</span><span class="p">.</span><span class="nx">getConversation</span><span class="p">(</span><span class="nx">CONVERSATION_ID</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span><span class="s1">&#39;Mary&#39;</span><span class="p">]);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;添加成功&#39;</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">members</span><span class="p">);</span>
  <span class="c1">// 此时对话成员为: [&#39;Mary&#39;, &#39;Tom&#39;, &#39;Jerry&#39;]</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">AVIMConversationQuery</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">client</span> <span class="n">conversationQuery</span><span class="p">];</span>
<span class="p">[</span><span class="n">query</span> <span class="nl">getConversationById</span><span class="p">:</span><span class="s">@&quot;CONVERSATION_ID&quot;</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">AVIMConversation</span> <span class="o">*</span><span class="n">conversation</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Jerry 邀请 Mary 到会话中</span>
    <span class="p">[</span><span class="n">conversation</span> <span class="nl">addMembersWithClientIds</span><span class="p">:</span><span class="l">@[</span><span class="s">@&quot;Mary&quot;</span><span class="l">]</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;邀请成功！&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}];</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">AVIMClient</span> <span class="n">jerry</span> <span class="o">=</span> <span class="n">AVIMClient</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;Jerry&quot;</span><span class="o">);</span>
<span class="kd">final</span> <span class="n">AVIMConversation</span> <span class="n">conv</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getConversation</span><span class="o">(</span><span class="s">&quot;CONVERSATION_ID&quot;</span><span class="o">);</span>
<span class="n">conv</span><span class="o">.</span><span class="na">addMembers</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;Mary&quot;</span><span class="o">),</span> <span class="k">new</span> <span class="n">AVIMConversationCallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 添加成功</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>var tom = await realtime.CreateClientAsync();
var conversation = await tom.GetConversationAsync(&quot;CONVERSATION_ID&quot;);
await tom.InviteAsync(conversation, &quot;Mary&quot;);
</pre></div></p>
<p>而 Jerry 添加如下代码也能随时知道当前对话还有谁加进来了：</p>
<p><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="p">{</span> <span class="nx">Event</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-realtime&#39;</span><span class="p">);</span>
<span class="c1">// Jerry 登录</span>
<span class="nx">realtime</span><span class="p">.</span><span class="nx">createIMClient</span><span class="p">(</span><span class="s1">&#39;Jerry&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">jerry</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 有用户被添加至某个对话</span>
    <span class="nx">jerry</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">MEMBERS_JOINED</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">membersjoinedEventHandler</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">members</span><span class="p">,</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">invitedBy</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">maryNoticedWhenJerryInviteMary</span><span class="p">{</span>
    <span class="c1">// Mary 创建一个 client，用自己的名字作为 clientId</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AVIMClient</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithClientId</span><span class="p">:</span><span class="s">@&quot;Mary&quot;</span><span class="p">];</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>

    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">client</span> <span class="nl">openWithCallback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 登录成功</span>
    <span class="p">}];</span>
<span class="p">}</span>
<span class="cp">#pragma mark - AVIMClientDelegate</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">conversation:</span><span class="p">(</span><span class="n">AVIMConversation</span> <span class="o">*</span><span class="p">)</span><span class="nv">conversation</span> <span class="nf">membersAdded:</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientIds</span> <span class="nf">byClientId:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientId</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;%@ 加入到对话，操作者为：%@&quot;</span><span class="p">,[</span><span class="n">clientIds</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">],</span><span class="n">clientId</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CustomMessageHandler</span> <span class="kd">extends</span> <span class="n">AVIMMessageHandler</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMemberJoined</span><span class="o">(</span><span class="n">AVIMClient</span> <span class="n">client</span><span class="o">,</span> <span class="n">AVIMConversation</span> <span class="n">conversation</span><span class="o">,</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">members</span><span class="o">,</span> <span class="n">String</span> <span class="n">invitedBy</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 手机屏幕上会显示一小段文字：Mary 加入到 551260efe4b01608686c3e0f ；操作者为：Tom</span>
        <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">AVOSCloud</span><span class="o">.</span><span class="na">applicationContext</span><span class="o">,</span>
          <span class="n">members</span> <span class="o">+</span> <span class="s">&quot;加入到&quot;</span> <span class="o">+</span> <span class="n">conversation</span><span class="o">.</span><span class="na">getConversationId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;；操作者为： &quot;</span>
              <span class="o">+</span> <span class="n">invitedBy</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">AVIMMessageManager</span><span class="o">.</span><span class="na">registerDefaultMessageHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomMessageHandler</span><span class="o">());</span>
</pre></div>
<div class="codehilite"><pre><span></span>jerry.OnMembersJoined += OnMembersJoined;
private void OnMembersJoined(object sender, AVIMOnInvitedEventArgs e)
{
    // e.InvitedBy 是该项操作的发起人, e.ConversationId 是该项操作针对的对话 Id
    Debug.Log(string.Format(&quot;{0} 邀请了 {1} 加入了 {2} 对话&quot;, e.InvitedBy,e.JoinedMembers, e.ConversationId));
}
</pre></div></p>
<p>{{ docs.langSpecStart('js') }}</p>
<p>其中 payload 参数包含如下内容：</p>
<ol>
<li><code class="codehilite">members</code>: 字符串数组, 被添加的用户 clientId 列表</li>
<li><code class="codehilite">invitedBy</code>  字符串, 邀请者 clientId</li>
</ol>
<p>{{ docs.langSpecEnd('js') }}</p>
<p>{{ docs.langSpecStart('cs') }}</p>
<p>其中 <code class="codehilite">AVIMOnInvitedEventArgs</code> 参数包含如下内容：
1. <code class="codehilite">InvitedBy</code>: 改操作的发起者
2. <code class="codehilite">JoinedMembers</code>：此次加入对话的包含的成员列表
3. <code class="codehilite">ConversationId</code>：被操作的对话</p>
<p>{{ docs.langSpecEnd('cs') }}</p>
<p>如下时序图可以简单的概括上述流程：</p>
<div class="codehilite"><pre><span></span>Tom-&gt;Cloud: 1.添加 Mary
Cloud-&gt;Tom: 2.下发通知：Mary 被你邀请加入了对话
Cloud--&gt;Mary: 2.下发通知：你被 Tom 邀请加入对话
Cloud--&gt;Jerry: 2.下发通知: Mary 被 Tom 邀请加入了对话
</pre></div>

<p>而 Mary 如果在另一台设备上登录了，Ta 可以参照<a href="#一对一单聊">一对一单聊</a>中 Jerry 的做法监听 <code class="codehilite">INVITED</code> 事件，就可以自己被邀请到了一个对话当中。</p>
<p>而<strong>重新创建一个对话，并在创建的时候指定至少为 2 的成员数量</strong>的方式如下：</p>
<p><div class="codehilite"><pre><span></span><span class="nx">tom</span><span class="p">.</span><span class="nx">createConversation</span><span class="p">({</span>
  <span class="c1">// 创建的时候直接指定 Jerry 和 Mary 一起加入多人群聊，当然根据需求可以添加更多成员</span>
  <span class="nx">members</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;Jerry&#39;</span><span class="p">,</span><span class="s1">&#39;Mary&#39;</span><span class="p">],</span>
  <span class="c1">// 对话名称</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Tom &amp; Jerry &amp; friends&#39;</span><span class="p">,</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">// Jerry 建立了与朋友们的会话</span>
<span class="bp">NSArray</span> <span class="o">*</span><span class="n">friends</span> <span class="o">=</span> <span class="l">@[</span><span class="s">@&quot;Jerry&quot;</span><span class="p">,</span> <span class="s">@&quot;Mary&quot;</span><span class="l">]</span><span class="p">;</span>
<span class="p">[</span><span class="n">tom</span> <span class="nl">createConversationWithName</span><span class="p">:</span><span class="s">@&quot;Tom &amp; Jerry &amp; friends&quot;</span> <span class="nl">clientIds</span><span class="p">:</span><span class="n">friends</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">AVIMConversation</span> <span class="o">*</span><span class="n">conversation</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;创建成功&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">tom</span><span class="o">.</span><span class="na">createConversation</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;Jerry&quot;</span><span class="o">,</span><span class="s">&quot;Mary&quot;</span><span class="o">),</span> <span class="s">&quot;Tom &amp; Jerry &amp; friends&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
   <span class="k">new</span> <span class="n">AVIMConversationCreatedCallback</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMConversation</span> <span class="n">conversation</span><span class="o">,</span> <span class="n">AVIMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="c1">// 创建成功</span>
           <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>var conversation = await tom.CreateConversationAsync(new string[]{ &quot;Jerry&quot;,&quot;Mary&quot; },&quot;Tom &amp; Jerry &amp; friends&quot;);
</pre></div></p>
<h3 id="2_1">2.群发消息<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>群聊和单聊一样，对话中的成员都会接收到对话内产生的消息。</p>
<p>Tom 向群聊对话发送了消息：</p>
<p><div class="codehilite"><pre><span></span><span class="nx">conversation</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="k">new</span> <span class="nx">TextMessage</span><span class="p">(</span><span class="s1">&#39;大家好，欢迎来到我们的群聊对话&#39;</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="p">[</span><span class="n">conversation</span> <span class="nl">sendMessage</span><span class="p">:[</span><span class="n">AVIMTextMessage</span> <span class="nl">messageWithText</span><span class="p">:</span><span class="s">@&quot;大家好，欢迎来到我们的群聊对话！&quot;</span> <span class="nl">attributes</span><span class="p">:</span><span class="nb">nil</span><span class="p">]</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;发送成功！&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">AVIMTextMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AVIMTextMessage</span><span class="o">();</span>
<span class="n">msg</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;大家好，欢迎来到我们的群聊对话！&quot;</span><span class="o">);</span>
<span class="c1">// 发送消息</span>
<span class="n">conversation</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="k">new</span> <span class="n">AVIMConversationCallback</span><span class="o">()</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;群聊&quot;</span><span class="o">,</span> <span class="s">&quot;发送成功！&quot;</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>await conversation.SendAsync(&quot;大家好，欢迎来到我们的群聊对话！&quot;);
</pre></div></p>
<p>而 Jerry 和 Mary 都会有 <code class="codehilite">Event.MESSAGE</code> 事件触发，利用它来接收群聊消息，这一点与一对一单聊没区别。</p>
<h3 id="_6">将他人踢出对话<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>刚才的代码演示的是添加新成员，而对应的删除成员的代码如下：</p>
<p>Tom 又把 Mary 踢出对话了:</p>
<p><div class="codehilite"><pre><span></span><span class="nx">conversation</span><span class="p">.</span><span class="nx">remove</span><span class="p">([</span><span class="s1">&#39;Mary&#39;</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;移除成功&#39;</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">members</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="p">[</span><span class="n">conversation</span> <span class="nl">removeMembersWithClientIds</span><span class="p">:</span><span class="l">@[</span><span class="s">@&quot;Mary&quot;</span><span class="l">]</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;踢人成功！&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span> <span class="n">conv</span><span class="o">.</span><span class="na">kickMembers</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;Mary&quot;</span><span class="o">),</span><span class="k">new</span> <span class="n">AVIMConversationCallback</span><span class="o">(){</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">){</span>
      <span class="o">}</span>
 <span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>await conversation.RemoveMembersAsync(&quot;Mary&quot;);
</pre></div></p>
<p>执行了这段代码之后会触发如下流程：</p>
<div class="codehilite"><pre><span></span>Tom-&gt;Cloud: 1. 对话中移除 Mary
Cloud--&gt;Mary: 2. 下发通知：你被 Tom 从对话中剔除了
Cloud--&gt;Jerry: 2. 下发通知：Mary 被 Tom 移除
Cloud--&gt;Tom: 2. 下发通知：Mary 被移除了对话 
</pre></div>

<h3 id="_7">加入对话<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>紧接着 William 通过 <code class="codehilite">Conversation.id</code> 他自己主动加入对话：</p>
<p>注意，如下代码运行的前提有几个前提：</p>
<ol>
<li>William 需要参照前面章节里面的创建了一个 <code class="codehilite">IMClient</code> 的实例，并且确保已经与云端建立连接。</li>
<li><code class="codehilite">590aa654fab00f41dda86f51</code> 是一个在 <code class="codehilite">_Conversation</code> 表里面真是存在的对话 Id。</li>
</ol>
<p><div class="codehilite"><pre><span></span><span class="nx">william</span><span class="p">.</span><span class="nx">getConversation</span><span class="p">(</span><span class="s1">&#39;590aa654fab00f41dda86f51&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">join</span><span class="p">();</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;加入成功&#39;</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">members</span><span class="p">);</span>
  <span class="c1">// 加入成功 [&#39;William&#39;, &#39;Tom&#39;, &#39;Jerry&#39;]</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">AVIMConversationQuery</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="p">[</span><span class="n">william</span> <span class="n">conversationQuery</span><span class="p">];</span>
<span class="p">[</span><span class="n">query</span> <span class="nl">getConversationById</span><span class="p">:</span><span class="s">@&quot;590aa654fab00f41dda86f51&quot;</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">AVIMConversation</span> <span class="o">*</span><span class="n">conversation</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">conversation</span> <span class="nl">joinWithCallback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;加入成功！&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}];</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">AVIMClient</span> <span class="n">william</span> <span class="o">=</span> <span class="n">AVIMClient</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;William&quot;</span><span class="o">);</span>
<span class="n">AVIMConversation</span> <span class="n">conv</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getConversation</span><span class="o">(</span><span class="s">&quot;590aa654fab00f41dda86f51&quot;</span><span class="o">);</span>
<span class="n">conv</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="k">new</span> <span class="n">AVIMConversationCallback</span><span class="o">(){</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">e</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
        <span class="c1">//加入成功</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>await william.JoinAsync(&quot;590aa654fab00f41dda86f51&quot;);
</pre></div></p>
<p>执行了这段代码之后会触发如下流程：</p>
<div class="codehilite"><pre><span></span>William-&gt;Cloud: 1.加入对话
Cloud--&gt;William: 2. 下发通知: 你已加入对话
Cloud--&gt;Tom: 2. 下发通知：William 加入对话
Cloud--&gt;Jerry: 2. 下发通知：William 加入对话
</pre></div>

<p>其他人则通过订阅 <code class="codehilite">MEMBERS_JOINED</code> 来接收 William 加入对话的通知:</p>
<p><div class="codehilite"><pre><span></span><span class="nx">jerry</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">MEMBERS_JOINED</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">membersJoinedEventHandler</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">members</span><span class="p">,</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">invitedBy</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">conversation:</span><span class="p">(</span><span class="n">AVIMConversation</span> <span class="o">*</span><span class="p">)</span><span class="nv">conversation</span> <span class="nf">membersAdded:</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientIds</span> <span class="nf">byClientId:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientId</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;%@ 加入到对话，操作者为：%@&quot;</span><span class="p">,[</span><span class="n">clientIds</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">],</span><span class="n">clientId</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMemberJoined</span><span class="o">(</span><span class="n">AVIMClient</span> <span class="n">client</span><span class="o">,</span> <span class="n">AVIMConversation</span> <span class="n">conversation</span><span class="o">,</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">members</span><span class="o">,</span> <span class="n">String</span> <span class="n">invitedBy</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 手机屏幕上会显示一小段文字：Tom 加入到 551260efe4b01608686c3e0f ；操作者为：Tom</span>
    <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">AVOSCloud</span><span class="o">.</span><span class="na">applicationContext</span><span class="o">,</span>
      <span class="n">members</span> <span class="o">+</span> <span class="s">&quot;加入到&quot;</span> <span class="o">+</span> <span class="n">conversation</span><span class="o">.</span><span class="na">getConversationId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;；操作者为： &quot;</span>
          <span class="o">+</span> <span class="n">invitedBy</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span></span>jerry.OnMembersJoined += OnMembersJoined;
private void OnMembersJoined(object sender, AVIMOnInvitedEventArgs e)
{
    // e.InvitedBy 是该项操作的发起人, e.ConversationId 是该项操作针对的对话 Id
    Debug.Log(string.Format(&quot;{0} 加入了 {1} 对话，操作者是 {2}&quot;,e.JoinedMembers, e.ConversationId, e.InvitedBy));
}
</pre></div></p>
<h3 id="_8">退出对话<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>Jerry 不想继续呆在这个对话里面了，他选择退出对话:</p>
<p><div class="codehilite"><pre><span></span><span class="nx">conversation</span><span class="p">.</span><span class="nx">quit</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;退出成功&#39;</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">members</span><span class="p">);</span>
  <span class="c1">// 退出成功 [&#39;William&#39;, &#39;Tom&#39;]</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="p">[</span><span class="n">conversation</span> <span class="nl">quitWithCallback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;退出成功！&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">conversation</span><span class="o">.</span><span class="na">quit</span><span class="o">(</span><span class="k">new</span> <span class="n">AVIMConversationCallback</span><span class="o">(){</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">){</span>
      <span class="k">if</span><span class="o">(</span><span class="n">e</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
      <span class="c1">//退出成功</span>
      <span class="o">}</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>jerry.LeaveAsync(conversation);
// 或者传入 conversation id
jerry.LeaveAsync(&quot;590aa654fab00f41dda86f51&quot;);
</pre></div></p>
<p>执行了这段代码之后会触发如下流程：</p>
<div class="codehilite"><pre><span></span>Jerry-&gt;Cloud: 1. 离开对话
Cloud--&gt;Jerry: 2. 下发通知：你已离开对话
Cloud--&gt;Mary: 2. 下发通知：Jerry 已离开对话
Cloud--&gt;Tom: 2. 下发通知：Jerry 已离开对话
</pre></div>

<p>而其他人需要通过订阅 <code class="codehilite">MEMBERS_LEFT</code> 来接收 Jerry 离开对话的事件通知:</p>
<p><div class="codehilite"><pre><span></span><span class="nx">mary</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">MEMBERS_LEFT</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">membersLeftEventHandler</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">members</span><span class="p">,</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">invitedBy</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">// mary 登录之后，jerry 退出了对话，在 mary 所在的客户端就会激发以下回调</span>
<span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">conversation:</span><span class="p">(</span><span class="n">AVIMConversation</span> <span class="o">*</span><span class="p">)</span><span class="nv">conversation</span> <span class="nf">membersRemoved:</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientIds</span> <span class="nf">byClientId:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientId</span><span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;%@ 离开了对话， 操作者为：%@&quot;</span><span class="p">,[</span><span class="n">clientIds</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">],</span><span class="n">clientId</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMemberLeft</span><span class="o">(</span><span class="n">AVIMClient</span> <span class="n">client</span><span class="o">,</span> <span class="n">AVIMConversation</span> <span class="n">conversation</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">members</span><span class="o">,</span>
    <span class="n">String</span> <span class="n">kickedBy</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 有其他成员离开时，执行此处逻辑</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span></span>mary.OnMembersLeft += OnMembersLeft;
private void OnMembersLeft(object sender, AVIMOnMembersLeftEventArgs e)
{
    // e.InvitedBy 是该项操作的发起人, e.ConversationId 是该项操作针对的对话 Id
    Debug.Log(string.Format(&quot;{0} 离开了 {1} 对话，操作者是 {2}&quot;,e.JoinedMembers, e.ConversationId, e.InvitedBy));
}
</pre></div></p>
<h3 id="_9">成员变更的事件通知总结<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>前面的时序图和代码针对成员变更的操作做了逐步的分析和阐述，为了确保开发者能够准确的使用事件通知，如下表格做了一个统一的归类和划分:</p>
<p>假设 Tom 和 Jerry 已经在对话内了：</p>
<p>操作|Tom|Jerry|Mary|William
&ndash;|&ndash;|&ndash;|&ndash;
Tom 添加 Mary|<code class="codehilite">MEMBERS_JOINED</code>|<code class="codehilite">MEMBERS_JOINED</code>|<code class="codehilite">INVITED</code>|/
Tom 剔除 Mary|<code class="codehilite">MEMBERS_LEFT</code>|<code class="codehilite">MEMBERS_LEFT</code>|<code class="codehilite">KICKED</code>|/
William 加入|<code class="codehilite">MEMBERS_JOINED</code>|<code class="codehilite">MEMBERS_JOINED</code>|/|<code class="codehilite">MEMBERS_JOINED</code>
Jerry 主动退出|<code class="codehilite">MEMBERS_LEFT</code>|<code class="codehilite">MEMBERS_LEFT</code>|/|<code class="codehilite">MEMBERS_LEFT</code></p>
<h3 id="_10">其他对话类型（聊天模式）<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>即时通讯服务提供的功能就是让一个客户端与其他客户端进行在线的消息互发，对应不同的使用场景除去刚才前两章节介绍的<a href="#一对一单聊">一对一单聊</a>和<a href="#多人群聊">多人群聊</a>之外,即时通讯也支持但不限于如下中流行的通讯模式：</p>
<ul>
<li>唯一聊天室</li>
<li>开放聊天室，例如直播中的弹幕聊天室。</li>
<li>服务号，例如公众号，游戏 GM 在线群发通知
</li>
</ul>
<p>关于上述的几种场景对应的实现，请参阅<a href="realtime-guide-intermediate.html#对话类型">进阶功能#对话类型</a>。</p>
<h2 id="_11">对话<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p>一个聊天应用在首页往往会展示当前用户加入的，最活跃的几个对话。</p>
<h3 id="_12">获取对话列表<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p><div class="codehilite"><pre><span></span><span class="nx">tom</span><span class="p">.</span><span class="nx">getQuery</span><span class="p">().</span><span class="nx">containsMembers</span><span class="p">([</span><span class="s1">&#39;Tom&#39;</span><span class="p">]).</span><span class="nx">find</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">conversations</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 默认按每个对话的最后更新日期（收到最后一条消息的时间）倒序排列</span>
  <span class="nx">conversations</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">conversation</span><span class="p">.</span><span class="nx">lastMessageAt</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">members</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">// Tom 构建一个查询</span>
<span class="n">AVIMConversationQuery</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="p">[</span><span class="n">tom</span> <span class="n">conversationQuery</span><span class="p">];</span>
<span class="c1">// 执行查询</span>
<span class="p">[</span><span class="n">query</span> <span class="nl">findConversationsWithCallback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="n">conversations</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;找到 %ld 个对话！&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">conversations</span> <span class="n">count</span><span class="p">]);</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">AVIMConversationsQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getConversationsQuery</span><span class="o">();</span>
<span class="n">query</span><span class="o">.</span><span class="na">findInBackground</span><span class="o">(</span><span class="k">new</span> <span class="n">AVIMConversationQueryCallback</span><span class="o">(){</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AVIMConversation</span><span class="o">&gt;</span> <span class="n">conversations</span><span class="o">,</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">){</span>
      <span class="k">if</span><span class="o">(</span><span class="n">e</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
      <span class="c1">//conversations 就是获取到的 conversation 列表</span>
      <span class="c1">//注意：按每个对话的最后更新日期（收到最后一条消息的时间）倒序排列</span>
      <span class="o">}</span>
    <span class="o">}</span>
<span class="o">});</span>      
</pre></div>
<div class="codehilite"><pre><span></span>var query = tom.GetQuery().WhereContainedIn(&quot;m&quot;,&quot;Tom&quot;);
await query.FindAsync();
</pre></div></p>
<p>上述代码默认返回最近活跃的 10 个对话，若要更改返回对话的数量，请设置 limit 值。</p>
<p><div class="codehilite"><pre><span></span><span class="nx">query</span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">query</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
</pre></div>
<div class="codehilite"><pre><span></span>query.Limit(20);
</pre></div></p>
<h3 id="_13">根据关键字查询<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>在某些场景下，我们需要根据对话的一些特性来做查找，比如我要查找名字里包含 NBA 的对话:</p>
<p><div class="codehilite"><pre><span></span><span class="nx">query</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;NBA&#39;</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="p">[</span><span class="n">query</span> <span class="nl">whereKey</span><span class="p">:</span><span class="s">@&quot;name&quot;</span> <span class="nl">containsString</span><span class="p">:</span><span class="s">@&quot;NBA&quot;</span><span class="p">];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="na">whereContains</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;NBA&quot;</span><span class="o">);</span>
</pre></div>
<div class="codehilite"><pre><span></span>query.WhereContains(&quot;name&quot;, &quot;NBA&quot;);
</pre></div></p>
<h3 id="_14">更多查询方式<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>关于上述的几种场景对应的实现，请参阅<a href="realtime-guide-intermediate.html#对话的查询">进阶功能#对话的查询</a></p>
<h2 id="_15">消息<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h2>
<p>消息的类型有很多种，使用最多的就是文本消息，其次是图像消息，还有一些短语音/短视频消息，文本消息和其他消息类型有本质的区别:</p>
<div class="callout callout-info">文本消息发送的就是本身的内容，而其他多媒体消息，例如一张图片实际上发送的是一个指向图像的链接，而图像本身的物理文件内容会被 SDK 持久化存储在云端文件存储服务中</div>

<h3 id="_16">图像消息<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<h4 id="_17">发送图像文件<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>我们从发送一张图片消息的生命周期的时序图来了解整个过程：</p>
<div class="codehilite"><pre><span></span>Tom--&gt;source: 1. 获取图像实体内容
Tom-&gt;Cloud: 2. 调用发送图像消息的接口
Cloud--&gt;AVFile: 3. SDK 后台上传文件到 AVFile 表
AVFile--&gt;Tom: 4. 返回图像的云端地址
Tom--&gt;Cloud: 5. SDK 将图像消息发送给云端
Cloud-&gt;Jerry: 6. 收到图像消息，根据接口获取图像的云端地址，在对话框里面做 UI 展现
</pre></div>

<p>图解：
1. source 可能是来自于 localStorage/camera， 表示图像的来源可以是本地存储例如 iPhone 手机的媒体库或者直接调用相机 API 实时地拍照获取的照片。
2. AVFile 是 LeanCloud 提供的文件存储服务对象，详细可以参阅<a href="storage_overview.html#文件存储 AVFile">文件存储 AVFile</a></p>
<p>对应的代码并没有时序图那样复杂，因为调用 send 接口的时候，SDK 会自动上传图像，不需要开发者再去关心这一步:</p>
<p><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">AV</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-storage&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="p">{</span> <span class="nx">ImageMessage</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-realtime-plugin-typed-messages&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">fileUploadControl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#photoFileUpload&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AV</span><span class="p">.</span><span class="nx">File</span><span class="p">(</span><span class="s1">&#39;avatar.jpg&#39;</span><span class="p">,</span> <span class="nx">fileUploadControl</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nx">file</span><span class="p">.</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ImageMessage</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
  <span class="nx">message</span><span class="p">.</span><span class="nx">setText</span><span class="p">(</span><span class="s1">&#39;发自我的 Ins&#39;</span><span class="p">);</span>
  <span class="nx">message</span><span class="p">.</span><span class="nx">setAttributes</span><span class="p">({</span> <span class="nx">location</span><span class="o">:</span> <span class="s1">&#39;旧金山&#39;</span> <span class="p">});</span>
  <span class="k">return</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;发送成功&#39;</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="bp">NSArray</span> <span class="o">*</span><span class="n">paths</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">);</span>
<span class="bp">NSString</span> <span class="o">*</span><span class="n">documentsDirectory</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
<span class="bp">NSString</span> <span class="o">*</span><span class="n">imagePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">documentsDirectory</span> <span class="nl">stringByAppendingPathComponent</span><span class="p">:</span><span class="s">@&quot;LeanCloud.png&quot;</span><span class="p">];</span>
<span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
<span class="n">AVFile</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="p">[</span><span class="n">AVFile</span> <span class="nl">fileWithLocalPath</span><span class="p">:</span><span class="n">imagePath</span> <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">];</span>
<span class="n">AVIMImageMessage</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="p">[</span><span class="n">AVIMImageMessage</span> <span class="nl">messageWithText</span><span class="p">:</span><span class="s">@&quot;萌妹子一枚&quot;</span> <span class="nl">file</span><span class="p">:</span><span class="n">file</span> <span class="nl">attributes</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">[</span><span class="n">conversation</span> <span class="nl">sendMessage</span><span class="p">:</span><span class="n">message</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;发送成功！&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">AVFile</span> <span class="n">file</span> <span class="o">=</span> <span class="n">AVFile</span><span class="o">.</span><span class="na">withAbsoluteLocalPath</span><span class="o">(</span><span class="s">&quot;San_Francisco.png&quot;</span><span class="o">,</span> <span class="n">Environment</span><span class="o">.</span><span class="na">getExternalStorageDirectory</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;/San_Francisco.png&quot;</span><span class="o">);</span>
<span class="c1">// 创建一条图片消息</span>
<span class="n">AVIMImageMessage</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AVIMImageMessage</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
<span class="n">m</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;发自我的小米手机&quot;</span><span class="o">);</span>
<span class="n">conv</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="k">new</span> <span class="n">AVIMConversationCallback</span><span class="o">()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 发送成功</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>// 假设在程序运行目录下有一张图片，Unity/Xamarin 可以参照这种做法通过路径获取图片
// 以下是发送图片消息的快捷用法
using (FileStream fileStream = new FileStream(Path.Combine(Path.GetDirectoryName(Assembly.GetEntryAssembly().Location), &quot;San_Francisco.png&quot;), FileMode.Open, FileAccess.Read))
{
    await conversation.SendImageAsync(&quot;San_Francisco.png&quot;, fileStream);
}
// 或者如下比较常规的用法

var imageMessage = new AVIMImageMessage();
imageMessage.File = new AVFile(&quot;San_Francisco.png&quot;, fileStream);
imageMessage.TextContent = &quot;发自我的 Windows&quot;;
await conversation.SendAsync(imageMessage);
</pre></div></p>
<h4 id="_18">发送图像链接<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>除了上述这种从本地直接发送图片文件的消息之外，在很多时候，用户可能从网络上或者别的应用中拷贝了一个图像的网络连接地址，当做一条图像消息发送到对话中，这种需求可以用如下代码来实现：</p>
<p><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">AV</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-storage&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="p">{</span> <span class="nx">ImageMessage</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-realtime-plugin-typed-messages&#39;</span><span class="p">);</span>
<span class="c1">// 从网络链接直接构建一个图像消息</span>
<span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AV</span><span class="p">.</span><span class="nx">File</span><span class="p">.</span><span class="nx">withURL</span><span class="p">(</span><span class="s1">&#39;萌妹子&#39;</span><span class="p">,</span> <span class="s1">&#39;http://pic2.zhimg.com/6c10e6053c739ed0ce676a0aff15cf1c.gif&#39;</span><span class="p">);</span>
<span class="nx">file</span><span class="p">.</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ImageMessage</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
  <span class="nx">message</span><span class="p">.</span><span class="nx">setText</span><span class="p">(</span><span class="s1">&#39;萌妹子一枚&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;发送成功&#39;</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">// Tom 发了一张图片给 Jerry</span>
<span class="n">AVFile</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="p">[</span><span class="n">AVFile</span> <span class="nl">fileWithURL</span><span class="p">:[</span><span class="nb">self</span> <span class="s">@&quot;http://ww3.sinaimg.cn/bmiddle/596b0666gw1ed70eavm5tg20bq06m7wi.gif&quot;</span><span class="p">]];</span>
<span class="n">AVIMImageMessage</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="p">[</span><span class="n">AVIMImageMessage</span> <span class="nl">messageWithText</span><span class="p">:</span><span class="s">@&quot;萌妹子一枚&quot;</span> <span class="nl">file</span><span class="p">:</span><span class="n">file</span> <span class="nl">attributes</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">[</span><span class="n">conversation</span> <span class="nl">sendMessage</span><span class="p">:</span><span class="n">message</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;发送成功！&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">AVFile</span> <span class="n">file</span> <span class="o">=</span><span class="k">new</span> <span class="n">AVFile</span><span class="o">(</span><span class="s">&quot;萌妹子&quot;</span><span class="o">,</span><span class="s">&quot;http://ww3.sinaimg.cn/bmiddle/596b0666gw1ed70eavm5tg20bq06m7wi.gif&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="n">AVIMImageMessage</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AVIMImageMessage</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
<span class="n">m</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;萌妹子一枚&quot;</span><span class="o">);</span>
<span class="c1">// 创建一条图片消息</span>
<span class="n">conv</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="k">new</span> <span class="n">AVIMConversationCallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 发送成功</span>
      <span class="o">}</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="nt">await</span> <span class="nt">conversation</span><span class="p">.</span><span class="nc">SendImageAsync</span><span class="o">(</span><span class="s2">&quot;http://ww3.sinaimg.cn/bmiddle/596b0666gw1ed70eavm5tg20bq06m7wi.gif&quot;</span><span class="o">,</span> <span class="s2">&quot;Satomi_Ishihara&quot;</span><span class="o">,</span> <span class="s2">&quot;萌妹子一枚&quot;</span><span class="o">);</span>
</pre></div></p>
<h4 id="_19">接收图像消息<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<p>对话中的其他成员修改一下接收消息的事件订阅逻辑，根据消息类型来做不同的 UI 展现：</p>
<p><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="p">{</span> <span class="nx">Event</span><span class="p">,</span> <span class="nx">TextMessage</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-realtime&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="p">{</span> <span class="nx">ImageMessage</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-realtime-plugin-typed-messages&#39;</span><span class="p">);</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">MESSAGE</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">messageEventHandler</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">conversation</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">file</span><span class="p">;</span>
   <span class="k">switch</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">ImageMessage</span><span class="p">.</span><span class="nx">TYPE</span><span class="o">:</span>
        <span class="nx">file</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">getFile</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;收到图像消息，url: &#39;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">.</span><span class="nx">url</span><span class="p">());</span>
        <span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">conversation:</span><span class="p">(</span><span class="n">AVIMConversation</span> <span class="o">*</span><span class="p">)</span><span class="nv">conversation</span> <span class="nf">didReceiveTypedMessage:</span><span class="p">(</span><span class="n">AVIMTypedMessage</span> <span class="o">*</span><span class="p">)</span><span class="nv">message</span> <span class="p">{</span>
    <span class="n">AVIMImageMessage</span> <span class="o">*</span><span class="n">imageMessage</span> <span class="o">=</span> <span class="p">(</span><span class="n">AVIMImageMessage</span> <span class="o">*</span><span class="p">)</span><span class="n">message</span><span class="p">;</span>

    <span class="c1">// 消息的 id</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">messageId</span> <span class="o">=</span> <span class="n">imageMessage</span><span class="p">.</span><span class="n">messageId</span><span class="p">;</span>
    <span class="c1">// 图像文件的 URL</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">imageUrl</span> <span class="o">=</span> <span class="n">imageMessage</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">url</span><span class="p">;</span>
    <span class="c1">// 发该消息的 ClientId</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">fromClientId</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="n">clientId</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">AVIMMessageManager</span><span class="o">.</span><span class="na">registerMessageHandler</span><span class="o">(</span><span class="n">AVIMImageMessage</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
    <span class="k">new</span> <span class="n">AVIMTypedMessageHandler</span><span class="o">&lt;</span><span class="n">AVIMImageMessage</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">AVIMImageMessage</span> <span class="n">msg</span><span class="o">,</span> <span class="n">AVIMConversation</span> <span class="n">conv</span><span class="o">,</span> <span class="n">AVIMClient</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//只处理 Jerry 这个客户端的消息</span>
            <span class="c1">//并且来自 conversationId 为 55117292e4b065f7ee9edd29 的 conversation 的消息    </span>
            <span class="k">if</span> <span class="o">(</span><span class="s">&quot;Jerry&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getClientId</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;55117292e4b065f7ee9edd29&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">conv</span><span class="o">.</span><span class="na">getConversationId</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">fromClientId</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getFrom</span><span class="o">();</span>
                <span class="n">String</span> <span class="n">messageId</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getMessageId</span><span class="o">();</span>
                <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getFileUrl</span><span class="o">();</span>
                <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">metaData</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getFileMetaData</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">metaData</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;size&quot;</span><span class="o">))</span> <span class="o">{</span>
                  <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span> <span class="n">metaData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;size&quot;</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">metaData</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;width&quot;</span><span class="o">))</span> <span class="o">{</span>
                  <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span> <span class="n">metaData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;width&quot;</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">metaData</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;height&quot;</span><span class="o">))</span> <span class="o">{</span>
                  <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span> <span class="n">metaData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;height&quot;</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">metaData</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;format&quot;</span><span class="o">))</span> <span class="o">{</span>
                  <span class="n">String</span> <span class="n">format</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">metaData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;format&quot;</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>private void OnMessageReceived(object sender, AVIMMessageEventArgs e)
{
    if (e.Message is AVIMImageMessage imageMessage)
    {
        Console.WriteLine(imageMessage.File.Url);
        // imageMessage.File 是一个 AVFile 对象，更多操作可以参考数据存储里面的文件
    }
}
</pre></div></p>
<h3 id="_20">多媒体消息<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>与图像消息一样，其他多媒体消息都拥有如下两种用法：</p>
<ul>
<li>如果发送的是多媒体消息本身的物理文件，那么它的的内容会先试用 <code class="codehilite">AVFile</code> 存储在云端，然后发送云端链接到对话当中，而在接收方的客户端只要对链接做一些处理，根据消息的类型不同做不同的 UI 展现，例如语音消息可以做成一个小按钮，用户点击之后就播放语音，而视频消息则是一张视频截图，用户点击之后播放视频，诸如此类。</li>
<li>如果是一个网络连接地址，它的物理内容并不会被存放于 <code class="codehilite">AVFile</code> 表内，而是直接将其转化成一个消息，发送出去</li>
</ul>
<h3 id="_21">其他类型消息<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>更多消息类型请点击<a href="realtime-guide-intermediate.html#消息类型">进阶功能#消息类型</a>。</p>
<h2 id="_22">消息记录<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h2>
<p>消息记录默认会在云端保存 <strong>180</strong> 天， SDK 提供了多种方式来获取到本地。开发者可以付费来延长这一期限，请联系 <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#64;&#108;&#101;&#97;&#110;&#99;&#108;&#111;&#117;&#100;&#46;&#114;&#111;&#99;&#107;&#115;">&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#64;&#108;&#101;&#97;&#110;&#99;&#108;&#111;&#117;&#100;&#46;&#114;&#111;&#99;&#107;&#115;</a>。另外可以参考 对话的有效期。你也随时可以通过 REST API 将聊天记录同步到自己的服务器上。</p>
<p>iOS 和 Android SDK 分别提供了内置的消息缓存机制，减少客户端对云端消息记录的查询次数，并且在离线情况下，也能查询到准确的消息记录。</p>
<h3 id="_23">获取对话的全部消息记录<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>如下代码可以获取一个对话最近的 10 条消息，注意，返回结果是按照时间<strong>由新到旧</strong>排序的：</p>
<p><div class="codehilite"><pre><span></span><span class="nx">conversation</span><span class="p">.</span><span class="nx">queryMessages</span><span class="p">({</span>
  <span class="nx">limit</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="c1">// limit 取值范围 1~1000，默认 20</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">messages</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 最新的十条消息，按时间增序排列</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">// 查询对话中最后 10 条消息， limit 取值范围 1~1000，默认 20</span>
<span class="p">[</span><span class="n">conversation</span> <span class="nl">queryMessagesWithLimit</span><span class="p">:</span><span class="mi">10</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="n">objects</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;查询成功！&quot;</span><span class="p">);</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">//  limit 取值范围 1~1000，默认 20</span>
<span class="n">conv</span><span class="o">.</span><span class="na">queryMessages</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="k">new</span> <span class="n">AVIMMessagesQueryCallback</span><span class="o">()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AVIMMessage</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">,</span> <span class="n">AVIMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//成功获取最新10条消息记录</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="o">//</span> <span class="nt">limit</span> <span class="err">取值范围</span> <span class="nt">1</span><span class="o">~</span><span class="nt">1000</span><span class="err">，默认</span> <span class="nt">20</span>
<span class="nt">var</span> <span class="nt">messages</span> <span class="o">=</span> <span class="nt">await</span> <span class="nt">conversation</span><span class="p">.</span><span class="nc">QueryMessageAsync</span><span class="o">(</span><span class="nt">limit</span><span class="o">:</span> <span class="nt">10</span><span class="o">);</span>
</pre></div></p>
<p>而如果想继续拉取更早的消息记录，可以使用如下代码：</p>
<p><div class="codehilite"><pre><span></span><span class="c1">// 创建一个迭代器，每次获取 10 条历史消息</span>
<span class="kd">var</span> <span class="nx">messageIterator</span> <span class="o">=</span> <span class="nx">conversation</span><span class="p">.</span><span class="nx">createMessagesIterator</span><span class="p">({</span> <span class="nx">limit</span><span class="o">:</span> <span class="mi">10</span> <span class="p">});</span>
<span class="c1">// 第一次调用 next 方法，获得前 10 条消息，还有更多消息，done 为 false</span>
<span class="nx">messageIterator</span><span class="p">.</span><span class="nx">next</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// result: {</span>
  <span class="c1">//   value: [message1, ..., message10],</span>
  <span class="c1">//   done: false,</span>
  <span class="c1">// }</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
<span class="c1">// 第二次调用 next 方法，获得第 11 ~ 20 条消息，还有更多消息，done 为 false</span>
<span class="nx">messageIterator</span><span class="p">.</span><span class="nx">next</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// result: {</span>
  <span class="c1">//   value: [message11, ..., message20],</span>
  <span class="c1">//   done: false,</span>
  <span class="c1">// }</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">// 查询对话中最后 10 条消息</span>
<span class="p">[</span><span class="n">conversation</span> <span class="nl">queryMessagesWithLimit</span><span class="p">:</span><span class="mi">10</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="n">messages</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;查询成功！&quot;</span><span class="p">);</span>
    <span class="c1">// 以第一页的最早的消息作为开始，继续向前拉取消息</span>
    <span class="n">AVIMMessage</span> <span class="o">*</span><span class="n">oldestMessage</span> <span class="o">=</span> <span class="p">[</span><span class="n">messages</span> <span class="n">firstObject</span><span class="p">];</span>
    <span class="p">[</span><span class="n">conversation</span> <span class="nl">queryMessagesBeforeId</span><span class="p">:</span><span class="n">oldestMessage</span><span class="p">.</span><span class="n">messageId</span> <span class="nl">timestamp</span><span class="p">:</span><span class="n">oldestMessage</span><span class="p">.</span><span class="n">sendTimestamp</span> <span class="nl">limit</span><span class="p">:</span><span class="mi">10</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="n">messagesInPage</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;查询成功！&quot;</span><span class="p">);</span>
    <span class="p">}];</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">//  limit 取值范围 1~1000，默认 20</span>
<span class="n">conv</span><span class="o">.</span><span class="na">queryMessages</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="k">new</span> <span class="n">AVIMMessagesQueryCallback</span><span class="o">()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AVIMMessage</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">,</span> <span class="n">AVIMException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//成功获取最新10条消息记录</span>
      <span class="c1">//返回的消息一定是时间增序排列，也就是最早的消息一定是第一个</span>
      <span class="n">AVIMMessage</span> <span class="n">oldestMessage</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

      <span class="n">conv</span><span class="o">.</span><span class="na">queryMessages</span><span class="o">(</span><span class="n">oldestMessage</span><span class="o">.</span><span class="na">getMessageId</span><span class="o">(),</span> <span class="n">oldestMessage</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(),</span><span class="mi">20</span><span class="o">,</span>
          <span class="k">new</span> <span class="n">AVIMMessageQueryCallback</span><span class="o">(){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AVIMMessage</span><span class="o">&gt;</span> <span class="n">messagesInPage</span><span class="o">,</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">){</span>
              <span class="k">if</span><span class="o">(</span><span class="n">e</span><span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                <span class="c1">//查询成功返回</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;Tom &amp; Jerry&quot;</span><span class="o">,</span><span class="s">&quot;got &quot;</span><span class="o">+</span><span class="n">messagesInPage</span><span class="o">.</span><span class="na">size</span><span class="o">()+</span><span class="s">&quot; messages &quot;</span><span class="o">);</span>
              <span class="o">}</span>
          <span class="o">}</span>
      <span class="o">});</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="o">//</span> <span class="nt">limit</span> <span class="err">取值范围</span> <span class="nt">1</span><span class="o">~</span><span class="nt">1000</span><span class="err">，默认</span> <span class="nt">20</span>
<span class="nt">var</span> <span class="nt">messages</span> <span class="o">=</span> <span class="nt">await</span> <span class="nt">conversation</span><span class="p">.</span><span class="nc">QueryMessageAsync</span><span class="o">(</span><span class="nt">limit</span><span class="o">:</span> <span class="nt">10</span><span class="o">);</span>
<span class="nt">var</span> <span class="nt">oldestMessage</span> <span class="o">=</span> <span class="nt">messages</span><span class="p">.</span><span class="nc">ToList</span><span class="o">()</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="o">;</span>
<span class="nt">var</span> <span class="nt">messagesInPage</span> <span class="o">=</span> <span class="nt">await</span> <span class="nt">conversation</span><span class="p">.</span><span class="nc">QueryMessageAsync</span><span class="o">(</span><span class="nt">beforeMessageId</span><span class="o">:</span> <span class="nt">oldestMessage</span><span class="p">.</span><span class="nc">Id</span><span class="o">,</span> <span class="nt">beforeTimeStamp</span><span class="o">:</span> <span class="nt">oldestMessage</span><span class="p">.</span><span class="nc">ServerTimestamp</span><span class="o">);</span> 
</pre></div></p>
<h3 id="_24">按照消息类型获取<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>如下代码的功能是：获取所有的图像消息：</p>
<p><div class="codehilite"><pre><span></span><span class="nx">conversation</span><span class="p">.</span><span class="nx">queryMessages</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">ImageMessage</span><span class="p">.</span><span class="nx">TYPE</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">messages</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">messages</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="p">[</span><span class="n">conversation</span> <span class="nl">queryMediaMessagesFromServerWithType</span><span class="p">:</span><span class="n">kAVIMMessageMediaTypeImage</span> <span class="nl">limit</span><span class="p">:</span><span class="mi">10</span> <span class="nl">fromMessageId</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">fromTimestamp</span><span class="p">:</span><span class="mi">0</span> <span class="nl">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="n">messages</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;查询成功！&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="n">msgType</span> <span class="o">=</span> <span class="o">.</span><span class="na">AVIMMessageType</span><span class="o">.</span><span class="na">TEXT_MESSAGE_TYPE</span><span class="o">;</span>
<span class="n">conversation</span><span class="o">.</span><span class="na">queryMessagesByType</span><span class="o">(</span><span class="n">msgType</span><span class="o">,</span> <span class="n">limit</span><span class="o">,</span> <span class="k">new</span> <span class="n">AVIMMessagesQueryCallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AVIMMessage</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">,</span> <span class="n">AVIMException</span> <span class="n">e</span><span class="o">){</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>// 传入泛型参数，SDK 会自动读取类型的信息发送给服务端，用作筛选目标类型的消息
var imageMessages = await conversation.QueryMessageAsync&lt;AVIMImageMessage&gt;();
</pre></div></p>
<p>如要获取更多图像消息，可以效仿前一章节中的示例代码，继续查询可以获取更多的图像消息。</p>
<h3 id="_25">更多的获取方式<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>更多消息类型请点击<a href="realtime-guide-intermediate.html#消息记录">进阶功能#消息记录</a></p>
<h2 id="_26">客户端事件与网络状态响应<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h2>
<p>{{ docs.note("注意：在网络中断的情况下，所有的消息收发和对话操作都会失败。开发者应该监听与网络状态相关的事件并更新 UI，以免影响用户的使用体验。") }}</p>
<p>当网络连接出现中断、恢复等状态变化时，SDK 会派发以下事件：</p>
<p>{{ docs.langSpecStart('js') }}</p>
<ul>
<li><code class="codehilite">DISCONNECT</code>：与服务端连接断开，此时聊天服务不可用。</li>
<li><code class="codehilite">OFFLINE</code>：网络不可用。</li>
<li><code class="codehilite">ONLINE</code>：网络恢复。</li>
<li><code class="codehilite">SCHEDULE</code>：计划在一段时间后尝试重连，此时聊天服务仍不可用。</li>
<li><code class="codehilite">RETRY</code>：正在重连。</li>
<li><code class="codehilite">RECONNECT</code>：与服务端连接恢复，此时聊天服务可用。</li>
</ul>
<p><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="p">{</span> <span class="nx">Event</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;leancloud-realtime&#39;</span><span class="p">);</span>

<span class="nx">realtime</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">DISCONNECT</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;服务器连接已断开&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">realtime</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">OFFLINE</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;离线（网络连接已断开）&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">realtime</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">ONLINE</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;已恢复在线&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">realtime</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">SCHEDULE</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attempt</span><span class="p">,</span> <span class="nx">delay</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">delay</span> <span class="o">+</span> <span class="s1">&#39;ms 后进行第&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;次重连&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">realtime</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">RETRY</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attempt</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;正在进行第&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;次重连&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">realtime</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Event</span><span class="p">.</span><span class="nx">RECONNECT</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;与服务端连接恢复&#39;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
{{ docs.langSpecEnd('js') }}</p>
<p>{{ docs.langSpecStart('objc') }}</p>
<p>在 AVIMClientDelegate 上会有如下事件通知：</p>
<ul>
<li><code class="codehilite">imClientPaused:(AVIMClient *)imClient</code> 指网络连接断开事件发生，此时聊天服务不可用。</li>
<li><code class="codehilite">imClientResuming:(AVIMClient *)imClient</code> 指网络断开后开始重连，此时聊天服务依然不可用。</li>
<li><code class="codehilite">imClientResumed:(AVIMClient *)imClient</code> 指网络连接恢复正常，此时聊天服务变得可用。</li>
</ul>
<p>{{ docs.langSpecEnd('objc') }}</p>
<p>{{ docs.langSpecStart('java') }}</p>
<p><code class="codehilite">AVIMClientEventHandler</code> 上会有如下事件通知：</p>
<ul>
<li><code class="codehilite">onConnectionPaused()</code> 指网络连接断开事件发生，此时聊天服务不可用。</li>
<li><code class="codehilite">onConnectionResume()</code> 指网络连接恢复正常，此时聊天服务变得可用。</li>
<li><code class="codehilite">onClientOffline()</code> 指单点登录被踢下线的事件。</li>
</ul>
<p>{{ docs.langSpecEnd('java') }}</p>
<p>{{ docs.langSpecStart('cs') }}</p>
<p><code class="codehilite">AVRealtime</code> 上会有如下事件通知：</p>
<ul>
<li><code class="codehilite">OnDisconnected</code> 指网络连接断开事件发生，此时聊天服务不可用。</li>
<li><code class="codehilite">OnReconnecting</code> 指网络正在尝试重连，此时聊天服务不可用。</li>
<li><code class="codehilite">OnReconnected</code> 指网络连接恢复正常，此时聊天服务变得可用。</li>
<li><code class="codehilite">OnReconnectFailed</code> 指重连失败，此时聊天服务不可用。</li>
</ul>
<p>{{ docs.langSpecEnd('cs') }}</p>
<h3 id="_27">断线重连<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>目前 SDK 默认内置了断线重连的功能，从客户端与云端建立连接成功开始，只要没有调用退出登录的接口，SDK 会一直尝试和云端保持长连接，此时 <code class="codehilite">IMClient</code> 的状态可以通过 网络状态响应接口得到。</p>
<p><strong>注意：用户如果自行实现了重连逻辑可能会报出 1001 错误。</strong></p>
<h2 id="_28">退出登录与断开连接<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h2>
<p><div class="codehilite"><pre><span></span><span class="nx">tom</span><span class="p">.</span><span class="nx">close</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Tom 退出登录&#39;</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="p">[</span><span class="n">tom</span> <span class="nl">closeWithCallback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;退出即时通讯服务&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">tom</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="k">new</span> <span class="n">AVIMClientCallback</span><span class="o">(){</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">(</span><span class="n">AVIMClient</span> <span class="n">client</span><span class="o">,</span><span class="n">AVIMException</span> <span class="n">e</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">e</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
        <span class="c1">//登出成功</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></div>
<div class="codehilite"><pre><span></span>await tom.CloseAsync();
</pre></div></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../im-overview/" title="服务总览" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                服务总览
              </span>
            </div>
          </a>
        
        
          <a href="../../push/push-overview/" title="服务总览" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                服务总览
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2014 - 2018 LeanCloud
          </div>
        
        powered by
        <a href="https://leancloud.cn">LeanCloud</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>