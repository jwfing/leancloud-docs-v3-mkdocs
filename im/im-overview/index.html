



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.5">
    
    
      
        <title>服务总览 - LeanCloud 文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/mdc-web.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/bootstrap.min.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#_1" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="LeanCloud 文档" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                LeanCloud 文档
              </span>
              <span class="md-header-nav__topic">
                服务总览
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." title="文档首页" class="md-tabs__link">
        文档首页
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../storage/storage-overview/" title="数据存储" class="md-tabs__link">
          数据存储
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../engine/engine-overview/" title="云引擎+云缓存" class="md-tabs__link">
          云引擎+云缓存
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="./" title="即时通讯" class="md-tabs__link md-tabs__link--active">
          即时通讯
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../push/push-overview/" title="消息推送" class="md-tabs__link">
          消息推送
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../sms/sms-overview/" title="短信" class="md-tabs__link">
          短信
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../game/play/play-overview/" title="游戏+云端" class="md-tabs__link">
          游戏+云端
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../solution/weapp/" title="微信小程序" class="md-tabs__link">
          微信小程序
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="LeanCloud 文档" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    LeanCloud 文档
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="文档首页" class="md-nav__link">
      文档首页
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      数据存储
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        数据存储
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage/storage-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage/object.md" title="对象存储与查询" class="md-nav__link">
      对象存储与查询
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage/user.md" title="用户管理" class="md-nav__link">
      用户管理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage/live-query.md" title="实时数据同步 LiveQuery" class="md-nav__link">
      实时数据同步 LiveQuery
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage/acl/" title="数据安全详解" class="md-nav__link">
      数据安全详解
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      云引擎+云缓存
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        云引擎+云缓存
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/engine-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/start.md" title="快速入门" class="md-nav__link">
      快速入门
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      网站托管
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        网站托管
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/nodejs.md" title="NodeJS" class="md-nav__link">
      NodeJS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/python.md" title="Python" class="md-nav__link">
      Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/php.md" title="PHP" class="md-nav__link">
      PHP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/dotnet.md" title="C#" class="md-nav__link">
      C#
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      云函数
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        云函数
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/storage-hook.md" title="数据存储 Hook" class="md-nav__link">
      数据存储 Hook
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/im-hook.md" title="即时通讯 Hook" class="md-nav__link">
      即时通讯 Hook
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/leancache.md" title="云缓存 LeanCache 使用指南" class="md-nav__link">
      云缓存 LeanCache 使用指南
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/faq.md" title="云引擎常见问题" class="md-nav__link">
      云引擎常见问题
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lean-cli.md" title="命令行工具 CLI 使用指南" class="md-nav__link">
      命令行工具 CLI 使用指南
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      即时通讯
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        即时通讯
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        服务总览
      </label>
    
    <a href="./" title="服务总览" class="md-nav__link md-nav__link--active">
      服务总览
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" title="功能和特性" class="md-nav__link">
    功能和特性
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="核心概念" class="md-nav__link">
    核心概念
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clientid" title="ClientID、用户和登录" class="md-nav__link">
    ClientID、用户和登录
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" title="在线状态" class="md-nav__link">
    在线状态
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conversation" title="对话（Conversation）" class="md-nav__link">
    对话（Conversation）
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#normal-conversation" title="普通对话（Normal Conversation）" class="md-nav__link">
    普通对话（Normal Conversation）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transient-conversation" title="暂态对话（Transient Conversation）" class="md-nav__link">
    暂态对话（Transient Conversation）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-conversation" title="系统对话（System Conversation）" class="md-nav__link">
    系统对话（System Conversation）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="对话类型比较" class="md-nav__link">
    对话类型比较
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="创建对话" class="md-nav__link">
    创建对话
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message" title="消息（Message）" class="md-nav__link">
    消息（Message）
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" title="富媒体消息" class="md-nav__link">
    富媒体消息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="离线消息" class="md-nav__link">
    离线消息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="离线推送通知" class="md-nav__link">
    离线推送通知
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" title="限制" class="md-nav__link">
    限制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="其他设置" class="md-nav__link">
    其他设置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="敏感词过滤" class="md-nav__link">
    敏感词过滤
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="广播消息" class="md-nav__link">
    广播消息
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" title="权限和认证" class="md-nav__link">
    权限和认证
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" title="云引擎签名范例" class="md-nav__link">
    云引擎签名范例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" title="用户登录的签名" class="md-nav__link">
    用户登录的签名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" title="开启对话签名" class="md-nav__link">
    开启对话签名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" title="群组功能的签名" class="md-nav__link">
    群组功能的签名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" title="查询聊天记录的签名" class="md-nav__link">
    查询聊天记录的签名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" title="黑名单的签名" class="md-nav__link">
    黑名单的签名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" title="测试签名" class="md-nav__link">
    测试签名
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hook" title="云引擎 Hook" class="md-nav__link">
    云引擎 Hook
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" title="使用场景" class="md-nav__link">
    使用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_messagereceived" title="_messageReceived" class="md-nav__link">
    _messageReceived
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_receiversoffline" title="_receiversOffline" class="md-nav__link">
    _receiversOffline
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" title="自定义离线消息推送通知的内容" class="md-nav__link">
    自定义离线消息推送通知的内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_messagesent" title="_messageSent" class="md-nav__link">
    _messageSent
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_29" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_conversationstart" title="_conversationStart" class="md-nav__link">
    _conversationStart
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_conversationstarted" title="_conversationStarted" class="md-nav__link">
    _conversationStarted
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_33" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_conversationadd" title="_conversationAdd" class="md-nav__link">
    _conversationAdd
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_conversationremove" title="_conversationRemove" class="md-nav__link">
    _conversationRemove
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_37" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_conversationupdate" title="_conversationUpdate" class="md-nav__link">
    _conversationUpdate
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_39" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" title="部署环境" class="md-nav__link">
    部署环境
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android" title="Android 开发指南" class="md-nav__link">
    Android 开发指南
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ios" title="iOS 开发指南" class="md-nav__link">
    iOS 开发指南
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#javascript" title="JavaScript 开发指南" class="md-nav__link">
    JavaScript 开发指南
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rest-api" title="REST API" class="md-nav__link">
    REST API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sdk" title="对话与消息管理 SDK" class="md-nav__link">
    对话与消息管理 SDK
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_42" title="系统对话" class="md-nav__link">
    系统对话
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_43" title="系统对话的创建" class="md-nav__link">
    系统对话的创建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" title="系统对话消息的发送" class="md-nav__link">
    系统对话消息的发送
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" title="获取系统对话消息记录" class="md-nav__link">
    获取系统对话消息记录
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" title="系统对话消息结构" class="md-nav__link">
    系统对话消息结构
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_sysmessage" title="_SysMessage" class="md-nav__link">
    _SysMessage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#web-hook" title="Web Hook" class="md-nav__link">
    Web Hook
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_47" title="高级功能" class="md-nav__link">
    高级功能
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_48" title="对话权限" class="md-nav__link">
    对话权限
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" title="黑名单" class="md-nav__link">
    黑名单
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_50" title="限制" class="md-nav__link">
    限制
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_51" title="对话的有效期" class="md-nav__link">
    对话的有效期
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_52" title="消息的有效期" class="md-nav__link">
    消息的有效期
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_53" title="云端错误码说明" class="md-nav__link">
    云端错误码说明
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" title="常见问题 FAQ" class="md-nav__link">
    常见问题 FAQ
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" title="要让单个群组消息进入「免打扰模式」，该如何做" class="md-nav__link">
    要让单个群组消息进入「免打扰模式」，该如何做
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" title="聊天好友关系如何实现" class="md-nav__link">
    聊天好友关系如何实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" title="聊天记录的保存时间和条数" class="md-nav__link">
    聊天记录的保存时间和条数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_57" title="聊天消息没有收到" class="md-nav__link">
    聊天消息没有收到
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iphone" title="为什么我的 iPhone 收不到离线消息推送" class="md-nav__link">
    为什么我的 iPhone 收不到离线消息推送
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android_1" title="Android 设备系统时间不准，会影响即时通讯服务吗？" class="md-nav__link">
    Android 设备系统时间不准，会影响即时通讯服务吗？
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      客户端开发指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        客户端开发指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../im-beginner/" title="基础入门" class="md-nav__link">
      基础入门
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../im-intermediate.md" title="进阶功能" class="md-nav__link">
      进阶功能
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../im-senior.md" title="高阶技巧" class="md-nav__link">
      高阶技巧
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3">
    
    <label class="md-nav__link" for="nav-4-3">
      服务端开发指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-3">
        服务端开发指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3-1" type="checkbox" id="nav-4-3-1">
    
    <label class="md-nav__link" for="nav-4-3-1">
      Hook
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-3-1">
        Hook
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/hook-nodejs.md" title="NodeJS" class="md-nav__link">
      NodeJS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/hook-python.md" title="Python" class="md-nav__link">
      Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/hook-php.md" title="PHP" class="md-nav__link">
      PHP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/hook-dotnet.md" title="C#" class="md-nav__link">
      C#
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3-2" type="checkbox" id="nav-4-3-2">
    
    <label class="md-nav__link" for="nav-4-3-2">
      管理开发指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-3-2">
        管理开发指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../engine/server-python.md" title="Python" class="md-nav__link">
      Python
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      消息推送
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        消息推送
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../push/push-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      开发指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        开发指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2-1" type="checkbox" id="nav-5-2-1">
    
    <label class="md-nav__link" for="nav-5-2-1">
      iOS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-2-1">
        iOS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../push/apns-cert/" title="APNS 证书配置" class="md-nav__link">
      APNS 证书配置
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2-2" type="checkbox" id="nav-5-2-2">
    
    <label class="md-nav__link" for="nav-5-2-2">
      Android
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-2-2">
        Android
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../push/android-mixpush/" title="Android 混合推送" class="md-nav__link">
      Android 混合推送
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      短信
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        短信
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../sms/sms-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2">
    
    <label class="md-nav__link" for="nav-6-2">
      开发指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        开发指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../sms/marketing/" title="营销短信" class="md-nav__link">
      营销短信
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../sms/notice/" title="通知短信" class="md-nav__link">
      通知短信
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../sms/user/" title="用户验证类短信" class="md-nav__link">
      用户验证类短信
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      游戏+云端
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        游戏+云端
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-1" type="checkbox" id="nav-7-1">
    
    <label class="md-nav__link" for="nav-7-1">
      多人实时对战
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-1">
        多人实时对战
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../game/play/play-overview/" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../game/play/multiplayer/" title="开发指南" class="md-nav__link">
      开发指南
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">
    
    <label class="md-nav__link" for="nav-7-2">
      排行榜
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        排行榜
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../game/leaderboard/leaderboard-overview.md" title="服务总览" class="md-nav__link">
      服务总览
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../game/leaderboard/leaderboard.md" title="开发指南" class="md-nav__link">
      开发指南
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      微信小程序
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        微信小程序
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../solution/weapp/" title="在微信小程序与小游戏中使用 LeanCloud" class="md-nav__link">
      在微信小程序与小游戏中使用 LeanCloud
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" title="功能和特性" class="md-nav__link">
    功能和特性
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="核心概念" class="md-nav__link">
    核心概念
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clientid" title="ClientID、用户和登录" class="md-nav__link">
    ClientID、用户和登录
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" title="在线状态" class="md-nav__link">
    在线状态
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conversation" title="对话（Conversation）" class="md-nav__link">
    对话（Conversation）
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#normal-conversation" title="普通对话（Normal Conversation）" class="md-nav__link">
    普通对话（Normal Conversation）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transient-conversation" title="暂态对话（Transient Conversation）" class="md-nav__link">
    暂态对话（Transient Conversation）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-conversation" title="系统对话（System Conversation）" class="md-nav__link">
    系统对话（System Conversation）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="对话类型比较" class="md-nav__link">
    对话类型比较
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="创建对话" class="md-nav__link">
    创建对话
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message" title="消息（Message）" class="md-nav__link">
    消息（Message）
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" title="富媒体消息" class="md-nav__link">
    富媒体消息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="离线消息" class="md-nav__link">
    离线消息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="离线推送通知" class="md-nav__link">
    离线推送通知
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" title="限制" class="md-nav__link">
    限制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="其他设置" class="md-nav__link">
    其他设置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="敏感词过滤" class="md-nav__link">
    敏感词过滤
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="广播消息" class="md-nav__link">
    广播消息
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" title="权限和认证" class="md-nav__link">
    权限和认证
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" title="云引擎签名范例" class="md-nav__link">
    云引擎签名范例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" title="用户登录的签名" class="md-nav__link">
    用户登录的签名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" title="开启对话签名" class="md-nav__link">
    开启对话签名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" title="群组功能的签名" class="md-nav__link">
    群组功能的签名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" title="查询聊天记录的签名" class="md-nav__link">
    查询聊天记录的签名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" title="黑名单的签名" class="md-nav__link">
    黑名单的签名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" title="测试签名" class="md-nav__link">
    测试签名
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hook" title="云引擎 Hook" class="md-nav__link">
    云引擎 Hook
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" title="使用场景" class="md-nav__link">
    使用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_messagereceived" title="_messageReceived" class="md-nav__link">
    _messageReceived
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_receiversoffline" title="_receiversOffline" class="md-nav__link">
    _receiversOffline
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" title="自定义离线消息推送通知的内容" class="md-nav__link">
    自定义离线消息推送通知的内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_messagesent" title="_messageSent" class="md-nav__link">
    _messageSent
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_29" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_conversationstart" title="_conversationStart" class="md-nav__link">
    _conversationStart
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_conversationstarted" title="_conversationStarted" class="md-nav__link">
    _conversationStarted
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_33" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_conversationadd" title="_conversationAdd" class="md-nav__link">
    _conversationAdd
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_conversationremove" title="_conversationRemove" class="md-nav__link">
    _conversationRemove
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_37" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_conversationupdate" title="_conversationUpdate" class="md-nav__link">
    _conversationUpdate
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_39" title="参数" class="md-nav__link">
    参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" title="返回" class="md-nav__link">
    返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" title="部署环境" class="md-nav__link">
    部署环境
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android" title="Android 开发指南" class="md-nav__link">
    Android 开发指南
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ios" title="iOS 开发指南" class="md-nav__link">
    iOS 开发指南
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#javascript" title="JavaScript 开发指南" class="md-nav__link">
    JavaScript 开发指南
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rest-api" title="REST API" class="md-nav__link">
    REST API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sdk" title="对话与消息管理 SDK" class="md-nav__link">
    对话与消息管理 SDK
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_42" title="系统对话" class="md-nav__link">
    系统对话
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_43" title="系统对话的创建" class="md-nav__link">
    系统对话的创建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" title="系统对话消息的发送" class="md-nav__link">
    系统对话消息的发送
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" title="获取系统对话消息记录" class="md-nav__link">
    获取系统对话消息记录
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" title="系统对话消息结构" class="md-nav__link">
    系统对话消息结构
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_sysmessage" title="_SysMessage" class="md-nav__link">
    _SysMessage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#web-hook" title="Web Hook" class="md-nav__link">
    Web Hook
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_47" title="高级功能" class="md-nav__link">
    高级功能
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_48" title="对话权限" class="md-nav__link">
    对话权限
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" title="黑名单" class="md-nav__link">
    黑名单
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_50" title="限制" class="md-nav__link">
    限制
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_51" title="对话的有效期" class="md-nav__link">
    对话的有效期
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_52" title="消息的有效期" class="md-nav__link">
    消息的有效期
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_53" title="云端错误码说明" class="md-nav__link">
    云端错误码说明
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" title="常见问题 FAQ" class="md-nav__link">
    常见问题 FAQ
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" title="要让单个群组消息进入「免打扰模式」，该如何做" class="md-nav__link">
    要让单个群组消息进入「免打扰模式」，该如何做
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" title="聊天好友关系如何实现" class="md-nav__link">
    聊天好友关系如何实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" title="聊天记录的保存时间和条数" class="md-nav__link">
    聊天记录的保存时间和条数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_57" title="聊天消息没有收到" class="md-nav__link">
    聊天消息没有收到
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iphone" title="为什么我的 iPhone 收不到离线消息推送" class="md-nav__link">
    为什么我的 iPhone 收不到离线消息推送
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android_1" title="Android 设备系统时间不准，会影响即时通讯服务吗？" class="md-nav__link">
    Android 设备系统时间不准，会影响即时通讯服务吗？
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="_1">即时通讯服务总览<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>即时通讯服务是 LeanCloud 消息服务中的重要一环。你不但可以为应用加入即时通讯、私信等常用功能，还能实现游戏对战等实时互动功能。</p>
<p>目前，我们提供 Android、iOS、JavaScript、Windows Phone 四个主要平台的客户端 SDK，也提供了一些 Demo 帮助你快速入门：</p>
<ul>
<li>iOS 聊天应用：</li>
<li>
<p><a href="chatkit-ios.html">ChatKit，自带 UI 的聊天工具包</a></p>
</li>
<li>
<p>Android 聊天应用：</p>
</li>
<li><a href="chatkit-android.html">ChatKit，自带 UI 的聊天工具包</a></li>
<li>
<p><a href="https://github.com/leancloud/leanchat-android">LeanChat Android 版</a></p>
</li>
<li>
<p>JavaScript 聊天应用</p>
</li>
<li><a href="https://github.com/leancloud/leanmessage-demo">LeanMessageDemo 网页版</a></li>
<li><a href="https://leancloud.github.io/js-realtime-sdk/demo/simple-chatroom/">Simple Chatroom</a>（<a href="https://github.com/leancloud/js-realtime-sdk/tree/next/demo/simple-chatroom">源码</a>）</li>
</ul>
<p>关于这些项目的更多介绍、截图预览，可见 <a href="https://github.com/leancloud/leancloud-demos">LeanCloud Demos</a> 。</p>
<p>目前新版本即时通讯服务接口与旧版本并不兼容，不能互相通信。我们推荐所有新用户直接使用新版本。已有的旧版本用户可以继续参考 <a href="realtime.html">v1 版本文档</a>，我们仍然会对已有版本提供支持，并可能在未来提供无缝的迁移方案。已经发布的旧版本用户不会在功能、资源等各个方面受到任何影响，请放心使用。</p>
<h2 id="_2">功能和特性<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>LeanCloud 即时通讯服务定位于完美实现网络层的通讯能力，其设计目标聚焦在：</p>
<ul>
<li><strong>快捷</strong><br/>
  LeanCloud 云端要能支持上亿终端同时在线，并且消息传递延时需要严格控制在毫秒以内。</li>
<li><strong>灵活</strong><br/>
  既要为完全依托 LeanCloud 平台的开发者考虑，也要为自有账户系统的用户设计：如果用户自己有完备的后台和账户系统，应该完全不用暴露内部数据就能使用我们的服务。而且，消息通知的手段要多样化，要让开发者有更多定制的能力。譬如聊天时对方不在线，应该能走「消息推送（Push Notification）」通道来及时提醒对方，并允许开发者对推送内容进行「私人定制」等等。</li>
<li><strong>安全</strong><br/>
  除了简单的 appId 和 secretKey 之外，还应该赋予开发者更多的安全控制能力，来保证聊天通道的私密性。</li>
</ul>
<p>LeanCloud 即时通讯服务的特性主要有：</p>
<ul>
<li><strong>与账户系统解耦合</strong><br/>
  任何终端用户要加入聊天，只需要提供一个唯一标识自己的 clientId 即可，这样可以尽量避免自有账户系统的应用数据暴露，也可以促使通信服务专注做好底层的「信使」角色；</li>
<li><strong>多账号登录</strong><br/>
  支持单个设备多个账号、单个账号多个设备同时登录，实时消息同步到所有设备。</li>
<li><strong>完整的聊天功能</strong><br/>
  支持单聊、群聊、聊天室、订阅号等不同聊天形式，并且具备完善的群组管理功能。</li>
<li><strong>支持富媒体、自定义类型消息</strong><br/>
  支持文本、图片、音频、视频和地理位置等多种格式的富媒体消息，并且开发者还可方便地自定义扩展。</li>
<li><strong>离线消息推送</strong><br/>
  消息在对方离线时，会自动通过 <a href="#离线推送通知">消息推送</a> 来及时送达对方，并且推送的消息文本可以由开发者自己控制。</li>
<li><strong>敏感词过滤</strong><br/>
  实时消息中出现的敏感词，会自动被过滤掉。详情见 <a href="#敏感词过滤">敏感词过滤</a>。</li>
<li><strong>聊天记录保存在云端</strong><br/>
  聊天记录自动保存在云端，允许开发者自由获取。</li>
<li><strong>第三方操作鉴权机制</strong><br/>
  为了保证信道的安全，也给开发者最大的控制自由，我们提供了操作鉴权的机制：开发者使用自己的服务器来充当鉴权服务器，对消息流向进行「许可控制」。对于消息路由过程中的重要操作（譬如登录、开启对话、邀请加入群组、从群组踢出某人等），实时消息 SDK 在发送请求之前，会先到鉴权服务器获得操作签名，LeanCloud 云端会验证签名有效性并完全按照鉴权结果来对操作放行或拒绝。</li>
<li><strong>系统账号、机器人 Hook 和公众号后台</strong><br/>
  支持系统中的小助手、机器人和公众号等场景，方便用户将即时通讯系统和自己已有的系统无缝集成，支持二次开发机器人和消息后台。</li>
</ul>
<p>我们提供几个层面用户接口：</p>
<ul>
<li>原生的 Android、iOS、Windows Phone 和 Web (JavaScript) 语言的客户端 SDK</li>
<li>帮助开发者完成后台管理和云端相关功能的 REST API</li>
<li>部署在 LeanCloud 环境中的云引擎 Hook 便于开发者修改默认的系统行为</li>
<li>可以实时监控在线用户数、消息数的开发者控制台</li>
</ul>
<h2 id="_3">核心概念<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="clientid">ClientID、用户和登录<a class="headerlink" href="#clientid" title="Permanent link">&para;</a></h3>
<p>即时通讯服务中的每一个终端称为一个 client。client 拥有一个在应用内唯一标识自己的 id。这个 id 由应用自己定义，必须是不多于 64 个字符的字符串。在大部分场合，client 都可以对应到应用中的某个「用户」，但是并不是只有真的用户才能做为 client，你完全可以把一个探测器当成一个 client，把它收集到的数据通过即时通讯服务广播给更多「人」。</p>
<p>默认情况下，LeanCloud 通信服务允许一个 clientId 在多个不同的设备上登录，也允许一个设备上有多个 clientId 同时登录。如果使用场景中需要限制用户只在一处登录，可以在登录时明确设置当前设备的 tag，
当 LeanCloud 检测到同一个 tag 的设备出现冲突时，会自动踢出已存在设备上的登录状态。开发者可以根据自己的应用场景选择合适的使用方式。</p>
<p>使用 LeanCloud 即时通讯 SDK 完成登录后，开发者就不必关心网络连接等状态，SDK 会自动为开发者保持连接状态，并根据网络状态自动重连。对于 Android 平台，我们使用常驻后台的服务保持在线状态；对于 iOS 和 Windows Phone
等平台，我们会在应用仍在前台时保持连接，当应用退到后台时，自动断开连接再激活平台原生的推送服务。</p>
<h4 id="_4">在线状态<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>我们目前在 SDK 和 <a href="realtime_rest_api_v2.html#查询在线成员">REST API</a> 上提供主动查询的机制帮助开发者查询目标用户的在线状态。</p>
<h3 id="conversation">对话（Conversation）<a class="headerlink" href="#conversation" title="Permanent link">&para;</a></h3>
<p>用户登录之后，与其他人进行消息沟通，即为开启了一个对话（Conversation）。开始聊天之前，需要先创建或者加入一个对话，然后再邀请其他人进来，之后所有参与者在这个对话内进行交流。所有消息都是由某一个 client 发往一个「对话」。</p>
<p>系统每创建一个对话，就会在云端的 <code class="codehilite">_Conversation</code> 表中增加一条记录，可以进入 <a href="/data.html?appid={{appid}}#/">控制台 &gt; <strong>存储</strong> &gt; <strong>数据</strong></a> 来查看该数据。</p>
<p><code class="codehilite">_Conversation</code> 表中字段名与对话的各个属性的对应关系为：</p>
<table>
<thead>
<tr>
<th>表字段</th>
<th>属性名</th>
<th>类型</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>attr</strong></td>
<td>attributes</td>
<td>Object</td>
<td>可选</td>
<td>自定义属性，供开发者扩展使用。</td>
</tr>
<tr>
<td><strong>objectId</strong></td>
<td>conversationId</td>
<td>String</td>
<td></td>
<td>对话 id（只读），由云端为该对话生成的一个全局唯一的 id。</td>
</tr>
<tr>
<td><strong>c</strong></td>
<td>creator</td>
<td>String</td>
<td></td>
<td>对话创建者的 clientId（只读）</td>
</tr>
<tr>
<td><strong>lm</strong></td>
<td>lastMessageAt</td>
<td>Date</td>
<td></td>
<td>对话中最后一条消息的发送或接收时间</td>
</tr>
<tr>
<td><strong>m</strong></td>
<td>members</td>
<td>Array</td>
<td></td>
<td>普通对话的所有参与者（仅针对普通对话，暂态对话和系统对话并不支持持久化的成员列表）</td>
</tr>
<tr>
<td><strong>mu</strong></td>
<td>mute</td>
<td>Array</td>
<td></td>
<td>将对话设为静音的参与者，这部分参与者不会收到推送。<br/>（仅针对 iOS 以及 Windows Phone 用户有效）</td>
</tr>
<tr>
<td><strong>name</strong></td>
<td>name</td>
<td>String</td>
<td>可选</td>
<td>对话的名字，可为群组命名。</td>
</tr>
<tr>
<td><strong>tr</strong></td>
<td>transient</td>
<td>Boolean</td>
<td>可选</td>
<td>是否为暂态对话</td>
</tr>
<tr>
<td><strong>sys</strong></td>
<td>system</td>
<td>Boolean</td>
<td>可选</td>
<td>是否是系统对话</td>
</tr>
<tr>
<td><strong>unique</strong></td>
<td>unique</td>
<td>Boolean</td>
<td>可选</td>
<td>内部字段，标记根据成员原子创建的对话。</td>
</tr>
</tbody>
</table>
<p>除了在各平台的 SDK 里面可以调用 API 创建对话外，我们也提供 REST API 可以让大家预先建立对话：对话的信息存储在 _Conversation 表中。</p>
<p>这里要特别讨论一下<strong>单聊</strong>、<strong>群聊</strong>、<strong>聊天室</strong>、<strong>公众号</strong>等使用场景。</p>
<ul>
<li><strong>单聊</strong><br/>
  就是两个 client 之间的对话，公开与否（能否让其他人看到这个对话存在）由应用层自己控制。一般而言，它是私密的，并且加入新的成员之后，会切换到新的对话（当然，也可以依然不离开当前对话，这一点还是由应用层来决定）。</li>
<li><strong>群聊</strong><br/>
  就是两个（含）以上 client 之间的对话，一般而言，可以添加和删除成员，并且会赋予群聊一个名字。随着成员的减少，群聊也可能只有两个甚至一个成员（成员的多少并不是区分群聊和单聊的关键）。群聊能否公开（譬如支持名字搜索），由应用自己决定。</li>
<li><strong>聊天室</strong><br/>
  很多应用使用的聊天室、弹幕、网页直播等都可以抽象成「聊天室」，它与群聊类似，都是多人参与的群组，但是也有一些区别：其一在于聊天室人数可能远大于群聊人数；其二在于聊天室强调的是在线人数，所有参与者进入聊天界面就算加入，关闭界面就算退出，所以聊天室不需要离线消息和推送通知，在线成员数比具体成员列表更有意义。</li>
<li><strong>公众号、机器人</strong><br/>
  对全部或者部分用户可见（由应用开发者决定）的账号，开发者可以利用这个账号给用户发广播通知，用户也可以通过这个账号反馈内容给开发者，开发者可以在后台看到消息，也可以利用 API 或 <a href="#Web_Hook">Web Hook</a> 将自己的业务系统集成进来。</li>
</ul>
<p>我们将以上场景抽象为「对话」这一概念，并分离出以下类型的对话：</p>
<h4 id="normal-conversation">普通对话（Normal Conversation）<a class="headerlink" href="#normal-conversation" title="Permanent link">&para;</a></h4>
<p>这是我们经常会用到的「对话」，单聊和群聊都通过它来实现。我们建议开发者将单聊/群聊、私密/公开等属性存入到 Conversation.attributes 之中，在应用层进行区别对待。</p>
<p>为了提高系统的灵活性，我们允许多个对话保持相同的成员，因此创建对话时系统总是默认创建新的对话。
如果开发者希望使用固定的对话，可以在创建对话时设置相应 SDK 上的 <code class="codehilite">unique</code> 选项，系统将查找对应成员相同且 <code class="codehilite">unique</code> 选项为 true 的对话，如果找到即返回已有的对话，如果没有则自动创建。
（注意，这种方式查找的对话仅对已经使用 <code class="codehilite">unique</code> 选项的对话有效，并且创建对话时不会触发 <code class="codehilite">_Conversation</code> 表在云引擎上的 <code class="codehilite">beforeSave</code> 等 hook）</p>
<p>REST API 在创建对话时同样支持 <code class="codehilite">unique</code> 参数。</p>
<p>对于应用中存在系统帐号的场景，我们建议您通过下文提到的<a href="#普通对话_Normal_Conversation_">系统对话</a>来实现，以避免对单一帐号创建过多的对话影响您应用的性能。</p>
<h4 id="transient-conversation">暂态对话（Transient Conversation）<a class="headerlink" href="#transient-conversation" title="Permanent link">&para;</a></h4>
<p>专门用来处理「聊天室」这种需求。与普通对话一样，它支持创建、自身主动加入、自身主动退出对话等操作；消息记录会被保存并可供获取；但不同之处在于：</p>
<ul>
<li><strong>不限成员上限</strong>，没有固定成员概念，加入即为成员，断线即为退出</li>
<li>不支持查询成员列表，你可以通过相关 API 查询在线人数。</li>
<li>不支持离线消息、离线推送通知等功能。</li>
<li>没有成员加入、离开的通知。</li>
<li>不支持邀请加入、踢出成员这两个操作。</li>
<li>一个用户一次登录只能加入一个暂态对话，加入新的暂态对话后会自动离开旧的暂态对话。</li>
<li>加入暂态对话后半小时内断网重连会自动加入原暂态对话，超过这个时间则需要重新加入。</li>
<li>在 <code class="codehilite">_Conversation</code> 表中，以 <code class="codehilite">tr</code> 为 <code class="codehilite">true</code> 来标记（<code class="codehilite">m</code>列在暂态对话中将被忽略）</li>
</ul>
<p>注意暂态对话没有持久化的成员概念，因此对普通对话的 <code class="codehilite">m</code> 字段的操作对暂态对话无效。</p>
<h4 id="system-conversation">系统对话（System Conversation）<a class="headerlink" href="#system-conversation" title="Permanent link">&para;</a></h4>
<p>这是用于实现机器人、公众号、服务账号等场景的对话，也可以用作发送应用内通知的通道。这种对话具有以下特点：</p>
<ul>
<li>加入即订阅，离开即退订，支持无限的订阅人数</li>
<li>开发者可以通过 REST API 以系统对话的渠道给所有用户、订阅用户或指定用户（不要求用户订阅）发消息</li>
<li>用户可以给系统对话发消息，消息和相关信息会存储在数据存储中的 <code class="codehilite">_SysMessage</code> 表，并不会被其他订阅用户收到</li>
<li>开发者可以配置 <a href="#Web_Hook">Web Hook</a> 地址接收用户发给系统对话的消息，并利用 REST API 发消息回复</li>
<li>在 SDK 层面，系统对话的接口与普通对话完全一致</li>
<li>在 <code class="codehilite">_Conversation</code> 表中，以 <code class="codehilite">sys</code> 为 <code class="codehilite">true</code> 来标记（<code class="codehilite">m</code>列在系统对话中将被忽略）</li>
</ul>
<h4 id="_5">对话类型比较<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>功能点</th>
<th>普通对话</th>
<th>暂态对话</th>
<th>系统对话</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>使用场景</strong></td>
<td>单聊、群聊</td>
<td>聊天室、弹幕、网页实时评论</td>
<td>公众号、机器人、下发加好友通知、自定义消息</td>
</tr>
<tr>
<td><strong>成员管理</strong></td>
<td>成员持久化保存，<br/>最高支持 500 个成员</td>
<td>没有持久化的成员数据，<br/>但支持成员没有上限</td>
<td>没有成员概念，<br/>开发者维护订阅关系，<br/>订阅人数没有上限</td>
</tr>
<tr>
<td><strong>收发消息</strong></td>
<td>只有成员可以收发消息</td>
<td>所有用户都可以发消息，<br/>当前在线的成员可以收到消息</td>
<td>开发者通过 API 给特定用户发消息，<br/>用户发送的消息到达数据库和 <a href="#Web_Hook">Web Hook</a></td>
</tr>
<tr>
<td><strong>消息记录</strong></td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
</tbody>
</table>
<h4 id="_6">创建对话<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>对话可以通过 SDK 和 REST API 创建。</p>
<p>在大部分使用场景中，普通对话通过 SDK 创建，用于最终用户之间自发的通信。
暂态对话和系统对话通常和应用中的特定实体绑定，可以通过 REST API 提前创建，通过应用中的业务逻辑
把对话 ID 下发给最终用户。</p>
<h3 id="message">消息（Message）<a class="headerlink" href="#message" title="Permanent link">&para;</a></h3>
<p>即时通讯服务的消息。我们的消息允许用户一次传输不超过 <strong>5 KB</strong> 的文本数据。在底层即时通讯允许开发者传输任何基于文本的消息数据，系统对消息格式没有任何要求，
开发者可以在文本协议基础上定义自己的应用层协议。</p>
<p>消息分为「普通消息」和「暂态消息」。LeanCloud 云端对于普通消息会提供接收回执、自动持久化存储、离线推送等功能。
但是暂态消息，则不会被自动保存，也不支持延迟接收，离线用户更不会收到推送通知，所以适合用来做控制协议。
譬如聊天过程中「某某正在输入中&hellip;」这样的状态信息，就适合通过暂态消息来发送，而用户输入的正式消息，则应该用普通消息来发送。</p>
<p>LeanCloud 对普通消息提供「至少一次」的到达保证，并且在官方 SDK 中支持对消息的去重，开发者无需关心。除了基于「推」模型的消息机制，我们还提供消息记录的机制允许
SDK 和 REST API 通过「拉」的方式获取任意时间点前的消息。</p>
<p>开发者可以通过 SDK 或 REST API 发送消息。
SDK 通常用于最终用户发送消息，而 REST API 是开发者从云端发送消息的接口。当从 REST API
发送消息时，开发者可以指定消息的发送者、对话 ID，对于系统对话还可以指定消息的接收者。</p>
<p>一个对话的消息记录会在云端保留 <strong>6 个月</strong>，也就是说一个对话可以查询到半年之内的历史消息记录。开发者可以付费来延长这一期限，请联系 <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#64;&#108;&#101;&#97;&#110;&#99;&#108;&#111;&#117;&#100;&#46;&#114;&#111;&#99;&#107;&#115;">&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#64;&#108;&#101;&#97;&#110;&#99;&#108;&#111;&#117;&#100;&#46;&#114;&#111;&#99;&#107;&#115;</a>。你也随时可以通过 REST API 将聊天记录同步到自己的服务器上。</p>
<h4 id="_7">富媒体消息<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>为了方便开发者的使用，我们提供了几种封装好的基于 JSON 格式的富媒体消息类型（TypedMessage），譬如：</p>
<ul>
<li>文本（TextMessage）</li>
<li>图片（ImageMessage）</li>
<li>音频（AudioMessage）</li>
<li>视频（VideoMessage）</li>
<li>位置（LocationMessage）</li>
</ul>
<p>这些消息类型可最大程度地简化使用步骤，能更好地满足通用需求。开发者也可以基于我们的框架，方便地扩展出自己的消息类型。</p>
<p>这些消息类型的层次关系为：</p>
<div class="codehilite"><pre><span></span>                                    Message
                                       |
                                  TypedMessage
                                       |
     __________________________________|__________________________________
     |             |            |             |               |           |
TextMessage  ImageMessage  AudioMessage  VideoMessage  LocationMessage   。。。
</pre></div>

<p>关于这部分消息的格式请参考
<a href="realtime_rest_api.html#富媒体消息格式说明">《即时通讯 REST API - 富媒体消息格式说明》</a>了解。</p>
<h4 id="_8">离线消息<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<p>开发者可以通过 <a href="/messaging.html?appid={{appid}}#/message/realtime/tool"><strong>控制台</strong> &gt; <strong>消息</strong> &gt; <strong>实时消息</strong> &gt; <strong>帮助</strong></a> 界面查询某个 Client ID 的在线状态和离线消息数。</p>
<p>当用户重新登录后，LeanCloud 提供两种方式进行下发离线消息：</p>
<ol>
<li><strong>默认方式</strong>：云端会对每个对话推送至多最近 20 条消息。这部分消息在用户上线后会以新消息的形式到达客户端，对于轻量级的应用这种方式可以满足开发者对离线消息的需求；</li>
<li><strong>未读数量方式</strong>：云端会返回离线期间产生未读消息的对话列表及未读消息数，开发者可以根据这个通知拉取离线消息记录收取离线消息，这种方式下开发者对消息的数量可以完全的控制；</li>
</ol>
<div class="callout callout-danger">注意，请不要混合使用上面两种方式，比如在 iOS 平台使用默认方式获取离线消息而 Android 平台使用未读数量方式获取离线消息。这种情况可能导致离线消息无法正常获取。</div>

<h4 id="_9">离线推送通知<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>对离线的 iOS 和 Windows Phone 用户，每次有离线消息时，我们提供发送离线推送通知的功能。要想使用本功能，用户需要 <strong>自定义推送的内容</strong>，目前有三种方式，按优先级从高到低依次为：</p>
<ol>
<li>动态内容方式</li>
</ol>
<p>如果希望推送通知显示动态内容，比如消息的实际内容，或根据消息内容、对话信息等上下文信息来自定义内容，则需要通过 <a href="#_receiversOffline">云引擎 Hook <code class="codehilite">_receiversOffline</code></a> 来实现。该类型优先级最高。</p>
<ol>
<li>
<p>消息附件方式</p>
</li>
<li>
<p>对于 SDK，通过各个 SDK 提供的 API 设置这条消息可能产生的推送内容，比如 JS 的是 <a href="https://leancloud.github.io/js-realtime-sdk/docs/Conversation.html#send">pushData 参数</a></p>
</li>
<li>
<p>对于 REST，通过 <a href="./realtime_rest_api_v2.html#发消息">push_data 参数</a>设定</p>
</li>
<li>
<p>静态内容方式</p>
</li>
</ol>
<p>由于不同平台的不同限制，且用户的消息正文可能还包含上层协议，所以我们允许用户在控制台中为应用设置一个静态的 APNs JSON，推送一条内容固定的通知。</p>
<p>进入 <a href="/messaging.html?appid={{appid}}#/message/realtime/conf">控制台 &gt; 消息 &gt; 实时消息 &gt; 设置 &gt; iOS 用户离线推送设置</a>，填入：</p>
<p><div class="codehilite"><pre><span></span>{&quot;alert&quot;:&quot;您有新的消息&quot;, &quot;badge&quot;:&quot;Increment&quot;}
</pre></div>
  注意，<code class="codehilite">Increment</code> 大小写敏感，表示自动增加应用 badge 上的数字计数。清除 badge 的操作请参考 <a href="ios_push_guide.html#清除_Badge">iOS 推送指南 &middot; 清除 badge</a>。</p>
<p><img alt="image" src="images/realtime_ios_push.png" /></p>
<p>此外，您还可以设置声音等推送属性，具体的字段可以参考<a href="./push_guide.html#消息内容_Data">推送 &middot; 消息内容 Data</a>。</p>
<h5 id="_10">限制<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h5>
<p>通知的过期时间是 7 天，也就是说，如果一个设备 7 天内没有连接到 APNs 或 MPNs，系统将不会再给这个设备推送通知。</p>
<h5 id="_11">原理<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h5>
<p>这部分平台的用户，在完成登录时，SDK 会自动关联当前的 Client ID 和设备。关联的方式是通过设备<strong>订阅</strong>名为 Client ID 的 Channel 实现的。开发者可以在数据存储的 <code class="codehilite">_Installation</code> 表中的 <code class="codehilite">channels</code> 字段查到这组关联关系。在实际离线推送时，系统根据用户 Client ID 找到对应的关联设备进行推送。由于即时通讯触发的推送量比较大，内容单一， 所以云端不会保留这部分记录，在 <strong>控制台 &gt; 消息 &gt; 推送记录</strong> 中也无法找到这些记录。</p>
<h5 id="_12">其他设置<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h5>
<p>推送默认使用<strong>生产证书</strong>，你也可以在 JSON 中增加一个 <code class="codehilite">_profile</code> 内部属性来选择实际推送的证书，如：</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;alert&quot;</span><span class="p">:</span>    <span class="s2">&quot;您有一条未读消息&quot;</span><span class="p">,</span>
  <span class="nt">&quot;_profile&quot;</span><span class="p">:</span> <span class="s2">&quot;dev&quot;</span>
<span class="p">}</span>
</pre></div>

<p>Apple 不支持在一次推送中向多个从属于不同 Team Id 的设备发推送。在使用 iOS Token Authentication 的鉴权方式后，如果应用配置了多个不同 Team Id 的 Private Key，请确认目标用户设备使用的 APNs Team ID 并将其填写在 <code class="codehilite">_apns_team_id</code> 参数内，以保证推送正常进行，只有指定 Team ID 的设备能收到推送。如：</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;alert&quot;</span><span class="p">:</span>    <span class="s2">&quot;您有一条未读消息&quot;</span><span class="p">,</span>
  <span class="nt">&quot;_apns_team_id&quot;</span><span class="p">:</span> <span class="s2">&quot;my_fancy_team_id&quot;</span>
<span class="p">}</span>
</pre></div>

<p><code class="codehilite">_profile</code> 和 <code class="codehilite">_apns_team_id</code> 属性均不会实际推送。</p>
<p>目前，设置界面的推送内容支持部分内置变量，你可以将上下文信息直接设置到推送内容中：</p>
<ul>
<li><code class="codehilite"><span class="cp">${</span><span class="n">convId</span><span class="cp">}</span></code> 推送相关的对话 ID</li>
<li><code class="codehilite"><span class="cp">${</span><span class="n">timestamp</span><span class="cp">}</span></code> 触发推送的时间戳（Unix 时间戳）</li>
<li><code class="codehilite"><span class="cp">${</span><span class="n">fromClientId</span><span class="cp">}</span></code> 消息发送者的 Client ID</li>
</ul>
<h4 id="_13">敏感词过滤<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>根据政策的要求，我们为多人的普通对话、暂态对话和系统对话进行敏感词过滤。</p>
<p>过滤的词库由 LeanCloud 提供，命中的敏感词将会被替换为 <code class="codehilite">***</code>。</p>
<p>支持用户自定义敏感词过滤文件。在 <a href="/dashboard/messaging.html?appid={{appid}}#/message/realtime/conf">控制台 &gt; 消息 &gt; 实时消息 &gt; 设置</a> 中开启「消息敏感词实时过滤功能」，上传敏感词文件即可。</p>
<p>如果开发者有较为复杂的过滤需求，我们推荐使用 <a href="#_messageReceived">云引擎 hook _messageReceived</a> 来实现过滤，在 hook 中开发者对消息的内容有完全的控制力。</p>
<h4 id="_14">广播消息<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>当开发者需要向所有用户发送广播消息时，可以利用广播消息的接口，而无需遍历所有的用户 ID 逐个发送。</p>
<p>广播消息具有以下特征：</p>
<ul>
<li>广播消息必须与系统对话关联，广播消息和一般的系统对话消息会混合在系统对话的记录中</li>
<li>用户离线时发送的广播消息，上线后会作为离线消息收到</li>
<li>广播消息具有实效性，可以设置过期时间；过期的消息不会作为离线消息发送给用户，不过仍然可以在历史消息中获取到</li>
<li>新用户第一次登录后，会收到最近一条未过期的系统广播消息</li>
</ul>
<p>除此以外广播消息与普通消息的处理完全一致。广播消息的发送可以参考<a href="./realtime_rest_api_v2.html#全局广播">广播消息 REST API</a></p>
<h2 id="_15">权限和认证<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h2>
<p>使用签名可以保证聊天通道的安全，这一功能默认是关闭的，可以在 <a href="/dashboard/messaging.html?appid={{appid}}#/message/realtime/conf">控制台 &gt; 消息 &gt; 实时消息 &gt; 设置 &gt; 实时消息选项</a> 中进行开启：</p>
<ul>
<li><strong>登录启用签名认证</strong>，用于控制所有的用户登录</li>
<li><strong>对话操作启用签名认证</strong>，用于控制新建或加入对话、邀请/踢出对话成员等操作</li>
<li><strong>聊天记录查询启用签名认证</strong>，用于控制聊天记录查询操作</li>
</ul>
<p>开发者可根据实际需要进行选择。一般来说，<strong>登录认证</strong> 能够满足大部分安全需求，而且我们也强烈建议开发者开启登录认证。
对于使用 AVUser 的应用，可使用 REST API <a href="./realtime_rest_api_v2.html#获取登录签名">获取 Client 登录签名</a> 进行登录认证。</p>
<p><img alt="image" src="images/leanmessage_signature2.png" /></p>
<ol>
<li>客户端进行登录或新建对话等操作，SDK 会调用 SignatureFactory 的实现，并携带用户信息和用户行为（登录、新建对话或群组操作）请求签名；</li>
<li>应用自有的权限系统，或应用在 LeanCloud 云引擎上的签名程序收到请求，进行权限验证，如果通过则利用下文所述的 <a href="#用户登录的签名">签名算法</a> 生成时间戳、随机字符串和签名返回给客户端；</li>
<li>客户端获得签名后，编码到请求中，发给 LeanCloud 即时通讯服务器；</li>
<li>即时通讯服务器对请求的内容和签名做一遍验证，确认这个操作是被应用服务器允许的，进而执行后续的实际操作。</li>
</ol>
<p>签名采用 <strong>Hmac-sha1</strong> 算法，输出字节流的十六进制字符串（hex dump）。针对不同的请求，开发者需要拼装不同组合的字符串，加上 UTC timestamp 以及随机字符串作为签名的消息。</p>
<h3 id="_16">云引擎签名范例<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>我们提供了一个运行在 LeanCloud <a href="leanengine_overview.html">云引擎</a> 上的 <a href="https://github.com/leancloud/realtime-messaging-signature-cloudcode">签名范例程序</a>
，它提供了基于 Web Hosting 和云函数两种方式的签名实现，你可以根据实际情况选择自己的实现。</p>
<h3 id="_17">用户登录的签名<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>签名的消息格式如下，注意 <code class="codehilite">clientid</code> 与 <code class="codehilite">timestamp</code> 之间是<u>两个冒号</u>：</p>
<div class="codehilite"><pre><span></span><span class="n">appid</span><span class="o">:</span><span class="n">clientid</span><span class="o">::</span><span class="n">timestamp</span><span class="o">:</span><span class="n">nonce</span>
</pre></div>

<table>
<thead>
<tr>
<th>参数</th>
<th>说明<a name="signature-param-table"></a></th>
</tr>
</thead>
<tbody>
<tr>
<td>appid</td>
<td>应用的 id</td>
</tr>
<tr>
<td>clientid</td>
<td>登录时使用的 clientId</td>
</tr>
<tr>
<td>timestamp</td>
<td>当前的 UTC 时间距离 unix epoch 的<strong>毫秒数</strong></td>
</tr>
<tr>
<td>nonce</td>
<td>随机字符串</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注意：签名的 key <strong>必须</strong> 是应用的 master key，你可以 <a href="/app.html?appid={{appid}}#/key">控制台 &gt; 设置 &gt; 应用 Key</a> 里找到。<strong>请保护好 master key，不要泄露给任何无关人员。</strong></p>
</blockquote>
<p>开发者可以实现自己的 SignatureFactory，调用远程服务器的签名接口获得签名。如果你没有自己的服务器，可以直接在 LeanCloud 云引擎上通过 <strong>网站托管</strong> 来实现自己的签名接口。在移动应用中直接做签名的作法 <strong>非常危险</strong>，它可能导致你的 <strong>master key</strong> 泄漏。</p>
<h3 id="_18">开启对话签名<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>新建一个对话的时候，签名的消息格式为：</p>
<div class="codehilite"><pre><span></span><span class="n">appid</span><span class="o">:</span><span class="n">clientid</span><span class="o">:</span><span class="n">sorted_member_ids</span><span class="o">:</span><span class="n">timestamp</span><span class="o">:</span><span class="n">nonce</span>
</pre></div>

<ul>
<li>appid、clientid、timestamp 和 nonce 的含义 <a href="#signature-param-table">同上</a>。</li>
<li>sorted_member_ids 是以半角冒号（:）分隔、<strong>升序排序</strong> 的 user id，即邀请参与该对话的成员列表。</li>
</ul>
<h3 id="_19">群组功能的签名<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>在群组功能中，我们对<strong>加群</strong>、<strong>邀请</strong>和<strong>踢出群</strong>这三个动作也允许加入签名，签名格式是：</p>
<div class="codehilite"><pre><span></span><span class="n">appid</span><span class="o">:</span><span class="n">clientid</span><span class="o">:</span><span class="n">convid</span><span class="o">:</span><span class="n">sorted_member_ids</span><span class="o">:</span><span class="n">timestamp</span><span class="o">:</span><span class="n">nonce</span><span class="o">:</span><span class="n">action</span>
</pre></div>

<ul>
<li>appid、clientid、sorted_member_ids、timestamp 和 nonce  的含义同上。对创建群的情况，这里 sorted_member_ids 是空字符串。</li>
<li>convid - 此次行为关联的对话 id。</li>
<li>action - 此次行为的动作，<strong>invite</strong> 表示加群和邀请，<strong>kick</strong> 表示踢出群。</li>
</ul>
<h3 id="_20">查询聊天记录的签名<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p><div class="codehilite"><pre><span></span><span class="n">appid</span><span class="o">:</span><span class="n">client_id</span><span class="o">:</span><span class="n">convid</span><span class="o">:</span><span class="n">nonce</span><span class="o">:</span><span class="n">signature_ts</span>
</pre></div>
* client_id 查看者 id（签名参数）
* nonce  签名随机字符串（签名参数）
* signature_ts 签名时间戳（签名参数），单位是秒
* signature  签名（签名参数）</p>
<h3 id="_21">黑名单的签名<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>由于黑名单有两种情况，所以签名格式也有两种：</p>
<ol>
<li>client 对 conversation
  <div class="codehilite"><pre><span></span><span class="n">appid</span><span class="o">:</span><span class="n">clientid</span><span class="o">:</span><span class="n">convid</span><span class="o">::</span><span class="n">timestamp</span><span class="o">:</span><span class="n">nonce</span><span class="o">:</span><span class="n">action</span>
</pre></div></li>
<li>
<p>action - 此次行为的动作，client-block-conversations 表示添加黑名单，client-unblock-conversations 表示取消黑名单</p>
</li>
<li>
<p>conversation 对 client
  <div class="codehilite"><pre><span></span><span class="n">appid</span><span class="o">:</span><span class="n">clientid</span><span class="o">:</span><span class="n">convid</span><span class="o">:</span><span class="n">sorted_member_ids</span><span class="o">:</span><span class="n">timestamp</span><span class="o">:</span><span class="n">nonce</span><span class="o">:</span><span class="n">action</span>
</pre></div></p>
</li>
<li>action - 此次行为的动作，conversation-block-clients 表示添加黑名单，conversation-unblock-clients 表示取消黑名单</li>
<li>sorted_member_ids 同上</li>
</ol>
<h3 id="_22">测试签名<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>开发者可以在控制台中方便地测试签名。进入 <a href="/dashboard/messaging.html?appid=#/message/realtime/client">消息 &gt; 实时消息 &gt; 用户</a>，输入一个 clientId 进行查找，找到后界面会显示 <strong>测试签名</strong> 按键及更多内容。</p>
<p><img src="images/console-im-signature-test.png" width="600" class="img-responsive"></p>
<h2 id="hook">云引擎 Hook<a class="headerlink" href="#hook" title="Permanent link">&para;</a></h2>
<p>对于普通消息，如果发送时部分成员不在线，LeanCloud 提供了选项，支持将离线消息以推送形式发送到客户端。如果开发者希望修改推送的内容，可以使用「云引擎 Hook」。</p>
<p>云引擎 Hook 允许你通过自定义的云引擎函数处理即时通讯中的某些事件，修改默认的流程等等。目前开放的 hook 云函数包括：</p>
<ul>
<li><strong>_messageReceived</strong><br/>
  消息达到服务器，群组成员已解析完成之后，发送给收件人之前。</li>
<li><strong>_receiversOffline</strong><br/>
  消息发送完成，存在离线的收件人。</li>
<li><strong>_messageSent</strong><br/>
  消息发送完成。</li>
<li><strong>_conversationStart</strong><br/>
  创建对话，在签名校验（如果开启）之后，实际创建之前。</li>
<li><strong>_conversationStarted</strong><br/>
  创建对话完成。</li>
<li><strong>_conversationAdd</strong><br/>
  向对话添加成员，在签名校验（如果开启）之后，实际加入之前，包括主动加入和被其他用户加入两种情况。</li>
<li><strong>_conversationRemove</strong><br/>
  从对话中踢出成员，在签名校验（如果开启）之后，实际踢出之前，用户自己退出对话不会调用。</li>
<li><strong>_conversationUpdate</strong><br/>
  修改对话属性、设置或取消对话消息提醒，在实际修改之前调用。</li>
</ul>
<h3 id="_23">使用场景<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>示例应用 <a href="https://github.com/leancloud/leanchat-android">LeanChat</a> 也用了云引擎 Hook 功能来自定义消息推送，通过解析上层消息协议获取消息类型和内容，以 <code class="codehilite">fromPeer</code> 得到发送者的名称，组装成 <code class="codehilite">pushMessage</code>，这样能使推送通知的用户体验更好。可参考 <a href="https://github.com/leancloud/leanchat-cloudcode/blob/master/cloud.js">leanchat-cloudcode 代码</a>。</p>
<p>与 conversation 相关的 hook 可以在应用签名之外增加额外的权限判断，控制对话是否允许被建立、某些用户是否允许被加入对话等。你可以用这一 hook 实现黑名单功能。</p>
<h3 id="_messagereceived"><code class="codehilite">_messageReceived</code><a class="headerlink" href="#_messagereceived" title="Permanent link">&para;</a></h3>
<p>这个 hook 发生在消息到达 LeanCloud 云端之后。如果是群组消息，我们会解析出所有消息收件人。</p>
<p>你可以通过返回参数控制消息是否需要被丢弃，删除个别收件人，还可以修改消息内容，例如过滤应用中的敏感词（<a href="leanengine_cloudfunction_guide-node.html#onIMMessageReceived">示例</a>）。返回空对象（<code class="codehilite">response.success({})</code>）则会执行系统默认的流程。</p>
<div class="callout callout-info">请注意，在这个 hook 的代码实现的任何分支上**请确保最终会调用 response.success 返回结果**，使得消息可以尽快投递给收件人。这个 hook 将**阻塞发送流程**，因此请尽量减少无谓的代码调用，提升效率。</div>

<p>如果你使用了 LeanCloud 默认提供的富媒体消息格式，云引擎参数中的 <code class="codehilite">content</code> 接收的是 JSON 结构的字符串形式。关于这个结构的详细说明，请参考 <a href="./realtime_rest_api.html#富媒体消息格式说明">即时通讯 REST API 指南 - 富媒体消息格式说明</a>。</p>
<h4 id="_24">参数<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>fromPeer</td>
<td>消息发送者的 ID</td>
</tr>
<tr>
<td>convId</td>
<td>消息所属对话的 ID</td>
</tr>
<tr>
<td>toPeers</td>
<td>解析出的对话相关的 Client ID</td>
</tr>
<tr>
<td>transient</td>
<td>是否是 transient 消息</td>
</tr>
<tr>
<td>content</td>
<td>消息体字符串</td>
</tr>
<tr>
<td>receipt</td>
<td>是否要求回执</td>
</tr>
<tr>
<td>timestamp</td>
<td>服务器收到消息的时间戳（毫秒）</td>
</tr>
<tr>
<td>sourceIP</td>
<td>消息发送者的 IP</td>
</tr>
</tbody>
</table>
<h4 id="_25">返回<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>drop</td>
<td>可选</td>
<td>如果返回真值消息将被丢弃</td>
</tr>
<tr>
<td>code</td>
<td>可选</td>
<td>当 drop 为 true 时可以下发一个应用自定义的整型错误码</td>
</tr>
<tr>
<td>content</td>
<td>可选</td>
<td>修改后的 content，如果不提供则保留原消息。</td>
</tr>
<tr>
<td>toPeers</td>
<td>可选</td>
<td>数组，修改后的收件人，如果不提供则保留原收件人。</td>
</tr>
</tbody>
</table>
<h3 id="_receiversoffline"><code class="codehilite">_receiversOffline</code><a class="headerlink" href="#_receiversoffline" title="Permanent link">&para;</a></h3>
<p>这个 hook 发生在有收件人离线的情况下，你可以通过它来自定义离线推送行为，包括推送内容、被推送用户或略过推送。你也可以直接在 hook 中触发自定义的推送。发往暂态对话的消息不会触发此 hook。</p>
<h4 id="_26">自定义离线消息推送通知的内容<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>AV.Cloud.define(&#39;_receiversOffline&#39;, function(request, response) {
    var params = request.params;

    var json = {
        // 自增未读消息的数目，不想自增就设为数字
        badge: &quot;Increment&quot;,
        sound: &quot;default&quot;,
        // 使用开发证书
        _profile: &quot;dev&quot;,
        // content 为消息的实际内容
        alert: params.content
    };

    var pushMessage = JSON.stringify(json);

    return {&quot;pushMessage&quot;: pushMessage};
})
</pre></div>

<p>有关可以在推送内容中加入的内置变量和其他可用设置，请参考 <a href="#离线推送通知">离线推送通知</a>。</p>
<h4 id="_27">参数<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>fromPeer</td>
<td>消息发送者 ID</td>
</tr>
<tr>
<td>convId</td>
<td>消息所属对话的 ID</td>
</tr>
<tr>
<td>offlinePeers</td>
<td>数组，离线的收件人列表</td>
</tr>
<tr>
<td>content</td>
<td>消息内容</td>
</tr>
<tr>
<td>timestamp</td>
<td>服务器收到消息的时间戳（毫秒）</td>
</tr>
<tr>
<td>mentionAll</td>
<td>布尔类型，表示本消息是否 @ 了所有成员</td>
</tr>
<tr>
<td>mentionOfflinePeers</td>
<td>被本消息 @ 且离线的成员 ID。如果 mentionAll 为 true，则该参数为空，表示所有 offlinePeers 参数内的成员全部被 @</td>
</tr>
</tbody>
</table>
<h4 id="_28">返回<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>skip</td>
<td>可选</td>
<td>如果为真将跳过推送（比如已经在云引擎里触发了推送或者其他通知）</td>
</tr>
<tr>
<td>offlinePeers</td>
<td>可选</td>
<td>数组，筛选过的推送收件人。</td>
</tr>
<tr>
<td>pushMessage</td>
<td>可选</td>
<td>推送内容，支持自定义 JSON 结构。</td>
</tr>
<tr>
<td>force</td>
<td>可选</td>
<td>如果为真将强制推送给 offlinePeers 里 mute 的用户，默认 false。</td>
</tr>
</tbody>
</table>
<h3 id="_messagesent"><code class="codehilite">_messageSent</code><a class="headerlink" href="#_messagesent" title="Permanent link">&para;</a></h3>
<p>在消息发送完成后执行，对消息发送性能没有影响，可以用来执行相对耗时的逻辑。</p>
<h4 id="_29">参数<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>fromPeer</td>
<td>消息发送者的 ID</td>
</tr>
<tr>
<td>convId</td>
<td>消息所属对话的 ID</td>
</tr>
<tr>
<td>msgId</td>
<td>消息 id</td>
</tr>
<tr>
<td>onlinePeers</td>
<td>当前在线发送的用户 id</td>
</tr>
<tr>
<td>offlinePeers</td>
<td>当前离线的用户 id</td>
</tr>
<tr>
<td>transient</td>
<td>是否是 transient 消息</td>
</tr>
<tr>
<td>system</td>
<td>是否是 system conversation</td>
</tr>
<tr>
<td>bin</td>
<td>是否是二进制消息</td>
</tr>
<tr>
<td>content</td>
<td>消息体字符串</td>
</tr>
<tr>
<td>receipt</td>
<td>是否要求回执</td>
</tr>
<tr>
<td>timestamp</td>
<td>服务器收到消息的时间戳（毫秒）</td>
</tr>
<tr>
<td>sourceIP</td>
<td>消息发送者的 IP</td>
</tr>
</tbody>
</table>
<h4 id="_30">返回<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h4>
<p>这个 hook 不会对返回值进行检查。只需返回 <code class="codehilite">{}</code> 即可。</p>
<h3 id="_conversationstart"><code class="codehilite">_conversationStart</code><a class="headerlink" href="#_conversationstart" title="Permanent link">&para;</a></h3>
<p>在创建对话时调用，发生在签名验证之后、创建对话之前。</p>
<h4 id="_31">参数<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>initBy</td>
<td>由谁发起的 clientId</td>
</tr>
<tr>
<td>members</td>
<td>初始成员数组，包含初始成员</td>
</tr>
<tr>
<td>attr</td>
<td>创建对话时的额外属性</td>
</tr>
</tbody>
</table>
<h4 id="_32">返回<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>reject</td>
<td>可选</td>
<td>是否拒绝，默认为 <strong>false</strong>。</td>
</tr>
<tr>
<td>code</td>
<td>可选</td>
<td>当 reject 为 true 时可以下发一个应用自定义的整型错误码。</td>
</tr>
</tbody>
</table>
<h3 id="_conversationstarted"><code class="codehilite">_conversationStarted</code><a class="headerlink" href="#_conversationstarted" title="Permanent link">&para;</a></h3>
<p>对话创建后调用</p>
<h4 id="_33">参数<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>convId</td>
<td>新生成的对话 Id</td>
</tr>
</tbody>
</table>
<h4 id="_34">返回<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h4>
<p>这个 hook 不对返回值进行处理，只需返回 <code class="codehilite">{}</code> 即可。</p>
<h3 id="_conversationadd"><code class="codehilite">_conversationAdd</code><a class="headerlink" href="#_conversationadd" title="Permanent link">&para;</a></h3>
<p>在将用户加入到对话时调用，发生在签名验证之后、加入对话之前。如果是自己加入，那么 <strong>initBy</strong> 和 <strong>members</strong> 的唯一元素是一样的。</p>
<h4 id="_35">参数<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>initBy</td>
<td>由谁发起的 clientId</td>
</tr>
<tr>
<td>members</td>
<td>要加入的成员，数组</td>
</tr>
<tr>
<td>convId</td>
<td>对话 id</td>
</tr>
</tbody>
</table>
<h4 id="_36">返回<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>reject</td>
<td>可选</td>
<td>是否拒绝，默认为 <strong>false</strong>。</td>
</tr>
<tr>
<td>code</td>
<td>可选</td>
<td>当 reject 为 true 时可以下发一个应用自定义的整型错误码。</td>
</tr>
</tbody>
</table>
<h3 id="_conversationremove"><code class="codehilite">_conversationRemove</code><a class="headerlink" href="#_conversationremove" title="Permanent link">&para;</a></h3>
<p>在创建对话时调用，发生在签名验证之后、从对话移除成员之前。移除自己时不会触发这个 hook。</p>
<h4 id="_37">参数<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>initBy</td>
<td>由谁发起</td>
</tr>
<tr>
<td>members</td>
<td>要踢出的成员，数组。</td>
</tr>
<tr>
<td>convId</td>
<td>对话 id</td>
</tr>
</tbody>
</table>
<h4 id="_38">返回<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>reject</td>
<td>可选</td>
<td>是否拒绝，默认为 <strong>false</strong>。</td>
</tr>
<tr>
<td>code</td>
<td>可选</td>
<td>当 reject 为 true 时可以下发一个应用自定义的整型错误码。</td>
</tr>
</tbody>
</table>
<h3 id="_conversationupdate"><code class="codehilite">_conversationUpdate</code><a class="headerlink" href="#_conversationupdate" title="Permanent link">&para;</a></h3>
<p>在修改对话属性、设置或取消对话消息提醒之前调用。</p>
<h4 id="_39">参数<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>initBy</td>
<td>由谁发起。</td>
</tr>
<tr>
<td>convId</td>
<td>对话 id。</td>
</tr>
<tr>
<td>mute</td>
<td>是否关闭当前对话提醒。</td>
</tr>
<tr>
<td>attr</td>
<td>待设置的对话属性。</td>
</tr>
</tbody>
</table>
<p>mute 和 attr 参数互斥，不会同时传递。</p>
<h4 id="_40">返回<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>reject</td>
<td>可选</td>
<td>是否拒绝，默认为 <strong>false</strong>。</td>
</tr>
<tr>
<td>code</td>
<td>可选</td>
<td>当 reject 为 true 时可以下发一个应用自定义的整型错误码。</td>
</tr>
<tr>
<td>attr</td>
<td>可选</td>
<td>修改后的待设置对话属性，如果不提供则保持原参数中的对话属性。</td>
</tr>
<tr>
<td>mute</td>
<td>可选</td>
<td>修改后的关闭对话提醒设置，如果不提供则保持原参数中的关闭提醒设置。</td>
</tr>
</tbody>
</table>
<p>mute 和 attr 参数互斥，不能同时返回。并且返回值必须与请求对应，请求中如果带着 attr，则返回值中只有 attr 参数有效，返回 mute 会被丢弃。同理，请求中如果带着 mute，返回值中如果有 attr 则 attr 会被丢弃。</p>
<h3 id="_41">部署环境<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>即时通讯的云引擎 Hook 要求云引擎部署在云引擎的 <strong>生产环境</strong>，测试环境仅用于开发者手动调用测试。由于缓存的原因，首次部署的云引擎 Hook 需要至多三分钟来正式生效，后续修改会实时生效。</p>
<p>更多使用方法请参考 <a href="leanengine_cloudfunction_guide-node.html">云引擎 · 云函数</a>。所有云引擎调用都有默认超时时间和容错机制，在出错情况下系统将按照默认的流程执行后续操作。</p>
<h2 id="android">Android 开发指南<a class="headerlink" href="#android" title="Permanent link">&para;</a></h2>
<p>参考 <a href="realtime_guide-android.html">Android 即时通讯开发指南</a></p>
<h2 id="ios">iOS 开发指南<a class="headerlink" href="#ios" title="Permanent link">&para;</a></h2>
<p>参考 <a href="realtime_guide-objc.html">iOS 即时通讯开发指南</a></p>
<h2 id="javascript">JavaScript 开发指南<a class="headerlink" href="#javascript" title="Permanent link">&para;</a></h2>
<p>参考 <a href="realtime_guide-js.html">JavaScript 即时通讯开发指南</a>。另外，我们已经开源了 JavaScript  Realtime SDK， 见 <a href="https://github.com/leancloud/js-realtime-sdk"> LeanCloud JavaScript Realtime SDK - Github 资源库</a> 。</p>
<h2 id="rest-api">REST API<a class="headerlink" href="#rest-api" title="Permanent link">&para;</a></h2>
<p>参考 <a href="realtime_rest_api_v2.html">即时通讯 REST API</a>。</p>
<h2 id="sdk">对话与消息管理 SDK<a class="headerlink" href="#sdk" title="Permanent link">&para;</a></h2>
<p>Python 与 JavaScript 的数据存储 SDK，基于 REST API 封装了一组对话及消息管理的接口，方便在服务端或者云引擎中进行对话管理、发送消息。具体文档参考：<a href="im-servermgmt-guide-python.html">即时通讯服务端管理开发指南</a>。</p>
<h2 id="_42">系统对话<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h2>
<p>系统对话可以用于实现机器人自动回复、公众号、服务账号等功能。在我们的 <a href="http://leancloud.github.io/leanmessage-demo/">官方聊天 Demo</a> 中就有一个使用系统对话 hook 实现的机器人 MathBot，它能计算用户发送来的数学表达式并返回结果，<a href="https://github.com/leancloud/leanmessage-demo/tree/master/server">其服务端源码</a> 可以从 GitHub 上获取。</p>
<h3 id="_43">系统对话的创建<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>系统对话也是对话的一种，创建后也是在 <code class="codehilite">_Conversation</code> 表中增加一条记录，只是该记录 <code class="codehilite">sys</code> 列的值为 true，从而与普通会话进行区别。具体创建方法请参考 <a href="realtime_rest_api_v2.html#创建服务号">REST API 创建服务号</a>。</p>
<h3 id="_44">系统对话消息的发送<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>系统对话给用户发消息请参考： <a href="realtime_rest_api_v2.html#给任意用户单独发消息">REST API - 给任意用户单独发消息</a>。
用户给系统对话发送消息跟用户给普通对话发消息方法一致。</p>
<p>您还可以利用系统对话发送广播消息给全部用户。相比遍历所有用户 ID 逐个发送，广播消息只需要调用一次 REST API。
关于广播消息的详细特征可以参考<a href="#广播消息">消息 - 广播消息</a>。</p>
<h3 id="_45">获取系统对话消息记录<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>获取系统对话给用户发送的消息记录请参考： <a href="realtime_rest_api_v2.html#查询服务号给某用户发的消息">查询服务号给某用户发的消息</a></p>
<p>获取用户给系统对话发送的消息记录有以下两种方式实现：
- <code class="codehilite">_SysMessage</code> 表方式，在应用首次有用户发送消息给某系统对话时自动创建，创建后我们将所有由用户发送到系统对话的消息都存储在该表中。
- <a href="#Web_Hook">Web Hook</a> 方式，这种方式需要开发者自行定义 <a href="#Web_Hook">Web Hook</a>，用于实时接收用户发给系统对话的消息。</p>
<h3 id="_46">系统对话消息结构<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<h4 id="_sysmessage"><code class="codehilite">_SysMessage</code><a class="headerlink" href="#_sysmessage" title="Permanent link">&para;</a></h4>
<p>存储用户发给系统对话的消息，各字段含义如下：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ackAt</td>
<td>消息送达的时间</td>
</tr>
<tr>
<td>bin</td>
<td>是否为二进制类型消息</td>
</tr>
<tr>
<td>conv</td>
<td>消息关联的系统对话 Pointer</td>
</tr>
<tr>
<td>data</td>
<td>消息内容</td>
</tr>
<tr>
<td>from</td>
<td>发消息用户的 Client ID</td>
</tr>
<tr>
<td>fromIp</td>
<td>发消息用户的 IP</td>
</tr>
<tr>
<td>msgId</td>
<td>消息的内部 ID</td>
</tr>
<tr>
<td>timestamp</td>
<td>消息创建的时间</td>
</tr>
</tbody>
</table>
<h4 id="web-hook">Web Hook<a class="headerlink" href="#web-hook" title="Permanent link">&para;</a></h4>
<p>需要开发者自行在 <a href="/messaging.html?appid={{appid}}#/message/realtime/conf">控制台&gt; <strong>消息</strong> &gt; <strong>实时消息</strong> &gt; <strong>设置</strong> &gt; <strong>系统对话消息回调设置</strong></a> 定义，来实时接收用户发给系统对话的消息，消息的数据结构与上文所述的 <code class="codehilite">_SysMessage</code> 一致。</p>
<p>当有用户向系统对话发送消息时，我们会通过 HTTP POST 请求将 JSON 格式的数据发送到用户设置的 Web Hook 上。请注意，我们调用 Web Hook 时并不是一次调用只发送一条消息，而是会以批量的形式将消息发送过去。从下面的发送消息格式中能看到，JSON 的最外层是个 Array。</p>
<p>超时时间为 5 秒，当用户 hook 地址超时没有响应，我们会重试至多 3 次。</p>
<p>发送的消息格式为：</p>
<div class="codehilite"><pre><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;fromIp&quot;</span><span class="p">:</span>      <span class="s2">&quot;121.238.214.92&quot;</span><span class="p">,</span>
    <span class="nt">&quot;conv&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;__type&quot;</span><span class="p">:</span>    <span class="s2">&quot;Pointer&quot;</span><span class="p">,</span>
      <span class="nt">&quot;className&quot;</span><span class="p">:</span> <span class="s2">&quot;_Conversation&quot;</span><span class="p">,</span>
      <span class="nt">&quot;objectId&quot;</span><span class="p">:</span>  <span class="s2">&quot;55b99ad700b0387b8a3d7bf0&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;msgId&quot;</span><span class="p">:</span>       <span class="s2">&quot;nYH9iBSBS_uogCEgvZwE7Q&quot;</span><span class="p">,</span>
    <span class="nt">&quot;from&quot;</span><span class="p">:</span>        <span class="s2">&quot;A&quot;</span><span class="p">,</span>
    <span class="nt">&quot;bin&quot;</span><span class="p">:</span>         <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;data&quot;</span><span class="p">:</span>        <span class="s2">&quot;你好，sys&quot;</span><span class="p">,</span>
    <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;__type&quot;</span><span class="p">:</span>    <span class="s2">&quot;Date&quot;</span><span class="p">,</span>
      <span class="nt">&quot;iso&quot;</span><span class="p">:</span>       <span class="s2">&quot;2015-07-30T14:37:42.584Z&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;updatedAt&quot;</span><span class="p">:</span>  <span class="p">{</span>
      <span class="nt">&quot;__type&quot;</span><span class="p">:</span>   <span class="s2">&quot;Date&quot;</span><span class="p">,</span>
      <span class="nt">&quot;iso&quot;</span><span class="p">:</span>      <span class="s2">&quot;2015-07-30T14:37:42.584Z&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>

<h2 id="_47">高级功能<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h2>
<h3 id="_48">对话权限<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>「对话权限」功能作为即时通讯的一项补充，可以将对话内成员划分成不同角色，实现类似 QQ 群管理员的效果。使用这个功能需要在控制台 即时通讯-设置 中开启「对话成员属性功能（成员角色管理功能）」。</p>
<p>目前系统内的角色与功能对应关系：</p>
<table>
<thead>
<tr>
<th>角色</th>
<th>功能列表</th>
</tr>
</thead>
<tbody>
<tr>
<td>Owner</td>
<td>永久性禁言、踢人、加人、拉黑、更新他人权限</td>
</tr>
<tr>
<td>Manager</td>
<td>永久性禁言、踢人、加人、拉黑、更新他人权限</td>
</tr>
<tr>
<td>Member</td>
<td>加人</td>
</tr>
</tbody>
</table>
<p>需要注意一点，目前不支持 Owner 的变更。</p>
<h3 id="_49">黑名单<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>「黑名单」功能可以实现类似微信 屏蔽 的效果，目前分为两大类</p>
<ul>
<li>对话 &rarr; 成员</li>
<li>成员 &rarr; 对话</li>
</ul>
<p>使用这个功能需要在控制台 即时通讯-设置 中开启「黑名单功能」。</p>
<h2 id="_50">限制<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h2>
<ul>
<li>对于客户端主动发起的操作会按照操作类型限制其频率。发消息操作限制为 <strong>每分钟 60 次</strong>，历史消息查询操作限制为 <strong>每分钟 120 次</strong>，其他类型操作包括加入对话、离开对话、登录服务、退出服务等均限制为 <strong>每分钟 30 次</strong>。当调用超过限制时，云端会拒绝响应这些超限的操作，这样如果操作本由 SDK 发起则表现为不会走回调。如果使用 REST API 发起各种操作，则不会受到上述频率的限制。</li>
<li>应用全局发送消息的速度默认为每分钟 3 万次，如果你的应用会超过此限制，请 <a href="/help.html">联系我们</a>。</li>
<li>客户端发送的单条消息大小不得超过 5 KB。</li>
<li>单个普通对话的成员上限为 500 个，如果您通过数据存储 API 向 m 字段加入了超过 500 个 id，我们只会使用其中的前 500 个。</li>
<li>请不要使用相同的 id 在大量设备上同时登录，如果系统检测到某个 id 同时在超过 5 个不同的 IP 上登录，会认为此 id 是重复使用的 id，之后此 id 当日的每次登录会按照 <code class="codehilite">id + IP</code> 的组合作为计费的独立用户。</li>
<li>如果单个用户有超过 50 个的对话存在未接收的离线消息，那么当该用户登录时服务端只会<strong>随机</strong>下发 50 个对话的离线消息或未读消息数量。也就是说服务端不会再下发超出对话数量限制的那部分离线消息，也不会下发离线消息数量，离线消息不会丟失但需要从历史记录中拉取得到。</li>
<li>单个对话未接收的离线消息数最多 100 条，超过后，系统会以先入先出方式存储新的离线消息，同时移除当前对话存储的最早的一条离线消息。被移除的离线消息可以通过历史消息记录查询，但不会产生离线消息提醒，也不会计入对话的未读消息计数。</li>
<li>系统广播消息一个应用一天最多发 30 条</li>
</ul>
<h3 id="_51">对话的有效期<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>一个对话（包括普通、暂态、系统对话）如果 <strong>1 年内</strong>没有通过 SDK 或者 REST API 发送过新的消息，或者它在 <code class="codehilite">_Conversation</code> 表中的任意字段没有被更新过，即被视为<strong>不活跃对话</strong>，云端会自动将其删除。（查询对话的消息记录并不会更新 <code class="codehilite">_Conversation</code> 表，所以只查询不发送消息的对话仍会被视为不活跃对话。）</p>
<p>不活跃的对话被删除后，当客户端再次通过 SDK 或 REST API 对其发送消息时，会遇到 
<code class="codehilite">4401 INVALID_MESSAGING_TARGET</code> 错误，表示该对话已经不存在了。同时，与该对话相关的消息历史也无法获取。</p>
<p>反之，活跃的对话会一直保存在云端。</p>
<p>相关参考 <a href="#消息的有效期">消息的有效期</a>。</p>
<h3 id="_52">消息的有效期<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>一个对话的消息记录会在云端保留 <strong>6 个月</strong>，也就是说一个对话可以查询到半年之内的历史消息记录。开发者可以付费来延长这一期限，请联系 <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#64;&#108;&#101;&#97;&#110;&#99;&#108;&#111;&#117;&#100;&#46;&#114;&#111;&#99;&#107;&#115;">&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#64;&#108;&#101;&#97;&#110;&#99;&#108;&#111;&#117;&#100;&#46;&#114;&#111;&#99;&#107;&#115;</a>。另外可以参考 <a href="#对话的有效期">对话的有效期</a>。你也随时可以通过 REST API 将聊天记录同步到自己的服务器上。 </p>
<h2 id="_53">云端错误码说明<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h2>
<p>即时通讯的错误码会以 SDK 异常或 WebSocket 关闭状态码的形式返回给客户端。当出现异常情况时，SDK 会输出状态码到日志里，以下是对部分状态码的简单说明：</p>
<table>
<thead>
<tr>
<th>代码</th>
<th>消息</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="codehilite">0</code></td>
<td><code class="codehilite">(无)</code></td>
<td>WebSocket 正常关闭，可能发生在服务器重启，或本地网络异常的情况。SDK 会自动重连，无需人工干预。</td>
</tr>
<tr>
<td><code class="text-nowrap">1006</code></td>
<td><code class="text-nowrap">(无)</code></td>
<td>WebSocket 连接非正常关闭，通常见于路由器配置对长连接限制的情况。SDK 会自动重连，无需人工干预。</td>
</tr>
<tr>
<td><code class="text-nowrap">4100</code></td>
<td><code class="text-nowrap">APP_NOT_AVAILABLE</code></td>
<td>应用不存在或应用禁用了即时通讯服务。</td>
</tr>
<tr>
<td><code class="text-nowrap">4101</code></td>
<td><code class="text-nowrap">DUPLICATED_LOGIN</code></td>
<td>同一个设备重复登录推送服务。该错误码与即时通讯服务无关。</td>
</tr>
<tr>
<td><code class="text-nowrap">4102</code></td>
<td><code class="text-nowrap">SIGNATURE_FAILED</code></td>
<td>登录签名验证失败。</td>
</tr>
<tr>
<td><code class="text-nowrap">4103</code></td>
<td><code class="text-nowrap">INVALID_LOGIN</code></td>
<td>Client Id 格式错误，超过 64 个字符。</td>
</tr>
<tr>
<td><code class="text-nowrap">4105</code></td>
<td><code class="text-nowrap">SESSION_REQUIRED</code></td>
<td>Session 没有打开就发送消息，或执行其他操作。常见的错误场景是调用 open session 后直接发送消息，正确的用法是在 Session 打开的回调里执行。</td>
</tr>
<tr>
<td><code class="text-nowrap">4107</code></td>
<td><code class="text-nowrap">READ_TIMEOUT</code></td>
<td>读超时，云端长时间没有收到客户端的数据，切断连接。SDK 包装了心跳包的机制，出现此错误通常是网络问题。SDK 会自动重连，无需人工干预。</td>
</tr>
<tr>
<td><code class="text-nowrap">4108</code></td>
<td><code class="text-nowrap">LOGIN_TIMEOUT</code></td>
<td>登录超时，连接后长时间没有完成 session open。通常是登录被拒绝等原因，出现此问题可能是使用方式有误，可以 <a href="https://leanticket.cn/t/leancloud">创建工单</a>，由我们技术顾问来给出建议。</td>
</tr>
<tr>
<td><code class="text-nowrap">4109</code></td>
<td><code class="text-nowrap">FRAME_TOO_LONG</code></td>
<td>包过长。消息大小超过 5 KB，请缩短消息或者拆分消息。</td>
</tr>
<tr>
<td><code class="text-nowrap">4110</code></td>
<td><code class="text-nowrap">INVALID_ORIGIN</code></td>
<td>设置安全域名后，当前登录的域名与安全域名不符合。</td>
</tr>
<tr>
<td><code class="text-nowrap">4111</code></td>
<td><code class="text-nowrap">SESSION_CONFLICT</code></td>
<td>设置单设备登录后，客户端被其他设备挤下线。</td>
</tr>
<tr>
<td><code class="text-nowrap">4112</code></td>
<td><code class="text-nowrap">SESSION_TOKEN_EXPIRED</code></td>
<td>Session 过期，请重新登录。</td>
</tr>
<tr>
<td><code class="text-nowrap">4113</code></td>
<td><code class="text-nowrap">APP_QUOTA_EXCEEDED</code></td>
<td>应用容量超限，当天登录用户数已经超过应用设定的最大值。</td>
</tr>
<tr>
<td><code class="text-nowrap">4114</code></td>
<td><code class="text-nowrap">UNPARSEABLE_RAW_MESSAGE</code></td>
<td>客户端发送的序列化数据服务器端无法解析。</td>
</tr>
<tr>
<td><code class="text-nowrap">4115</code></td>
<td><code class="text-nowrap">KICKED_BY_APP</code></td>
<td>客户端被 REST API 管理接口强制下线。</td>
</tr>
<tr>
<td><code class="text-nowrap">4116</code></td>
<td><code class="text-nowrap">MESSAGE_SENT_QUOTA_EXCEEDED</code></td>
<td>应用单位时间内发送消息量超过限制，消息被拒绝。</td>
</tr>
<tr>
<td><code class="text-nowrap">4200</code></td>
<td><code class="text-nowrap">INTERNAL_ERROR</code></td>
<td>服务器内部错误，如果反复出现请收集相关线索并 <a href="https://leanticket.cn/t/leancloud">创建工单</a>，我们会尽快解决。</td>
</tr>
<tr>
<td><code class="text-nowrap">4201</code></td>
<td><code class="text-nowrap">SEND_MESSAGE_TIMEOUT</code></td>
<td>通过 API 发送消息超时。</td>
</tr>
<tr>
<td><code class="text-nowrap">4301</code></td>
<td><code class="text-nowrap">CONVERSATION_API_FAILED</code></td>
<td>上游 API 调用异常，请查看报错信息了解错误详情。</td>
</tr>
<tr>
<td><code class="text-nowrap">4302</code></td>
<td><code class="text-nowrap">CONVERSATION_SIGNATURE_FAILED</code></td>
<td>对话相关操作签名错误</td>
</tr>
<tr>
<td><code class="text-nowrap">4303</code></td>
<td><code class="text-nowrap">CONVERSATION_NOT_FOUND</code></td>
<td>发送消息，或邀请等操作对应的对话不存在。</td>
</tr>
<tr>
<td><code class="text-nowrap">4304</code></td>
<td><code class="text-nowrap">CONVERSATION_FULL</code></td>
<td>对话成员已满，不能再添加。</td>
</tr>
<tr>
<td><code class="text-nowrap">4305</code></td>
<td><code class="text-nowrap">CONVERSATION_REJECTED_BY_APP</code></td>
<td>对话操作被应用的云引擎 Hook 拒绝。</td>
</tr>
<tr>
<td><code class="text-nowrap">4306</code></td>
<td><code class="text-nowrap">CONVERSATION_UPDATE_FAILED</code></td>
<td>更新对话操作失败。</td>
</tr>
<tr>
<td><code class="text-nowrap">4307</code></td>
<td><code class="text-nowrap">CONVERSATION_READ_ONLY</code></td>
<td>该对话为只读，不能更新或增删成员。</td>
</tr>
<tr>
<td><code class="text-nowrap">4308</code></td>
<td><code class="text-nowrap">CONVERSATION_NOT_ALLOWED</code></td>
<td>该对话禁止当前用户发送消息。</td>
</tr>
<tr>
<td><code class="text-nowrap">4309</code></td>
<td><code class="text-nowrap">CONVERSATION_UPDATE_REJECTED</code></td>
<td>更新对话的请求被拒绝，当前用户不在对话中。</td>
</tr>
<tr>
<td><code class="text-nowrap">4310</code></td>
<td><code class="text-nowrap">CONVERSATION_QUERY_FAILED</code></td>
<td>查询对话失败，常见于慢查询导致的超时或受其他慢查询导致的数据库响应慢。</td>
</tr>
<tr>
<td><code class="text-nowrap">4311</code></td>
<td><code class="text-nowrap">CONVERSATION_LOG_FAILED</code></td>
<td>拉取对话消息记录失败，常见与超时的情况。</td>
</tr>
<tr>
<td><code class="text-nowrap">4312</code></td>
<td><code class="text-nowrap">CONVERSATION_LOG_REJECTED</code></td>
<td>拉取对话消息记录被拒绝，当前用户不在对话中。</td>
</tr>
<tr>
<td><code class="text-nowrap">4313</code></td>
<td><code class="text-nowrap">SYSTEM_CONVERSATION_REQUIRED</code></td>
<td>该功能仅对系统对话有效。</td>
</tr>
<tr>
<td><code class="text-nowrap">4314</code></td>
<td><code class="text-nowrap">NORMAL_CONVERSATION_REQUIRED</code></td>
<td>该功能仅对普通对话有效。</td>
</tr>
<tr>
<td><code class="text-nowrap">4315</code></td>
<td><code class="text-nowrap">CONVERSATION_BLACKLISTED</code></td>
<td>当前用户被加入此对话的黑名单，无法发送消息。</td>
</tr>
<tr>
<td><code class="text-nowrap">4316</code></td>
<td><code class="text-nowrap">TRANSIENT_CONVERSATION_REQUIRED</code></td>
<td>该功能仅对暂态对话有效。</td>
</tr>
<tr>
<td><code class="text-nowrap">4317</code></td>
<td><code class="text-nowrap">CONVERSATION_MEMBERSHIP_REQUIRED</code></td>
<td>该操作要求用户是对话成员。</td>
</tr>
<tr>
<td><code class="text-nowrap">4318</code></td>
<td><code class="text-nowrap">CONVERSATION_API_QUOTA_EXCEEDED</code></td>
<td>对话操作超出了 API 请求限制，需要提升应用级别。</td>
</tr>
<tr>
<td><code class="text-nowrap">4401</code></td>
<td><code class="text-nowrap">INVALID_MESSAGING_TARGET</code></td>
<td>发送消息的对话不存在，或当前用户不在对话中。</td>
</tr>
<tr>
<td><code class="text-nowrap">4402</code></td>
<td><code class="text-nowrap">MESSAGE_REJECTED_BY_APP</code></td>
<td>发送的消息被应用的云引擎 Hook 拒绝。</td>
</tr>
<tr>
<td><code class="text-nowrap">4403</code></td>
<td><code class="text-nowrap">MESSAGE_OWNERSHIP_REQUIRED</code></td>
<td>没有操作目标消息的权限</td>
</tr>
<tr>
<td><code class="text-nowrap">4404</code></td>
<td><code class="text-nowrap">MESSAGE_NOT_FOUND</code></td>
<td>找不到被操作的消息</td>
</tr>
</tbody>
</table>
<h2 id="faq">常见问题 FAQ<a class="headerlink" href="#faq" title="Permanent link">&para;</a></h2>
<h3 id="_54">要让单个群组消息进入「免打扰模式」，该如何做<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>对于普通对话的新消息，LeanCloud 即时通讯服务有选项支持将消息以 Push Notification 的方式通知当前不在线的成员，但是有时候，这种推送会非常频繁对用户造成干扰。LeanCloud 提供选项，支持让单个用户关闭特定对话的离线消息推送。具体可以看相应平台的开发指南文档。</p>
<h3 id="_55">聊天好友关系如何实现<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>LeanCloud 即时通讯服务是完全独立的即时通讯业务抽象，专注在即时通讯本身，所以即时通讯的业务逻辑中，并不含有好友关系，以及对应的聊天用户数据信息（如头像、名称等）。即时通讯与其他业务逻辑完全隔离，不耦合，唯一关联的就是 clientId。这样做的好处是显而易见的，比如你可以很容易让匿名用户直接通信，你也可以自定义一些好友逻辑，总之可以做成因为任意逻辑而匹配产生的聊天行为。</p>
<p>当然，如果你想维护一套好友关系，完全可以使用你自己的逻辑，只要存储着每个用户在即时通讯中的 clientId 即可。我们推荐使用 LeanCloud 的存储，即 LeanStorage，这样可以结合 LeanCloud 中的 User 相关对象来简单地实现账户系统，以及与之相关的存储，详情可以阅读对应的 SDK 开发指南。</p>
<h3 id="_56">聊天记录的保存时间和条数<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>一个对话的消息记录会在云端保留 <strong>6 个月</strong>，也就是说一个对话可以查询到半年之内的历史消息记录。开发者可以付费来延长这一期限，请联系 <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#64;&#108;&#101;&#97;&#110;&#99;&#108;&#111;&#117;&#100;&#46;&#114;&#111;&#99;&#107;&#115;">&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#64;&#108;&#101;&#97;&#110;&#99;&#108;&#111;&#117;&#100;&#46;&#114;&#111;&#99;&#107;&#115;</a>。你也随时可以通过 REST API 将聊天记录同步到自己的服务器上。</p>
<h3 id="_57">聊天消息没有收到<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>当出现聊天消息没有收到的情况，你可以按照以下思路排查：</p>
<ul>
<li>调用消息记录 API 查看消息是否到达了云端</li>
<li>
<p>如果只有一个消息接收者，可以检查消息记录中对应条目的 <code class="codehilite">ack-at</code> 字段判断消息是否到达了客户端</p>
</li>
<li>
<p>在 <a href="/messaging.html?appid={{appid}}#/message/realtime/tool">控制台 &gt; <strong>消息</strong> &gt; <strong>实时消息</strong> &gt; <strong>帮助</strong></a> 页面的文本框里输入对应的 Client ID，查看是否在线，以及是否有离线消息。</p>
</li>
</ul>
<h3 id="iphone">为什么我的 iPhone 收不到离线消息推送<a class="headerlink" href="#iphone" title="Permanent link">&para;</a></h3>
<p>请先参考 <a href="#聊天消息没有收到">聊天消息没有收到</a>。在 <a href="/messaging.html?appid={{appid}}#/message/realtime/conf">控制台 &gt; <strong>消息</strong> &gt; <strong>实时消息</strong> &gt; <strong>设置</strong> &gt; <strong>iOS 用户离线推送设置</strong> &gt; <strong>推送内容</strong></a> 
填写「您有新的未读消息」后，当对方不在线的时候，便会触发一个 APNs 的推送。首先，请确保控制台能向 iOS 推送消息，也即如下图所示的推送能顺利到达 iOS 系统，请参考 <a href="ios_push_guide.html">iOS 推送开发文档</a>。</p>
<p><img alt="image" src="images/realtime_faq_push.png" /></p>
<p>之后，还要确保对方确实是离线，如果对方程序在前台并且网络良好，则不会触发推送。如果对方网络未连接，则下次联网的时候收到回调，也不触发推送。也可以利用控制台实时消息页的用户状态查询来确保对方处于离线状态，如下图。</p>
<p><img alt="image" src="images/realtime_faq_console.png" /></p>
<p>离线消息推送默认用的是生产环境编辑框里上传的证书。所以，调试时可能要上传开发证书，并在推送内容中设置 <code class="codehilite">_profile</code> 属性来选择开发证书推送，如 <code class="codehilite">{&quot;alert&quot;: &quot;你有一条未读消息&quot;, &quot;_profile&quot;: &quot;dev&quot;}</code></p>
<p>检查方法总结如下：</p>
<ul>
<li>检查 <code class="codehilite">_Installation</code> 表中是否有设备订阅了对应的 Client ID</li>
<li>检查普通的 iOS 推送是否到达</li>
<li>检查证书设置</li>
<li>在控制台检查接收方是否在离线状态</li>
</ul>
<h3 id="android_1">Android 设备系统时间不准，会影响即时通讯服务吗？<a class="headerlink" href="#android_1" title="Permanent link">&para;</a></h3>
<p>可能会，取决于证书的时间。当错误的系统时间和当前时间的误差，大于证书的有效时间，就会导致 SSL 握手失败，进而让即时通讯服务整体不可用。</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../engine/engine-overview/" title="服务总览" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                服务总览
              </span>
            </div>
          </a>
        
        
          <a href="../im-beginner/" title="基础入门" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                基础入门
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2014 - 2018 LeanCloud
          </div>
        
        powered by
        <a href="https://leancloud.cn">LeanCloud</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>